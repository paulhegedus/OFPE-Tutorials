<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Edit/Run Google Earth Engine</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">OFPE Framework</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Diagrams
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="ofpe_overview.html">OFPE Overview</a>
    </li>
    <li>
      <a href="db_management.html">Database Management</a>
    </li>
    <li>
      <a href="dat_import.html">Data Import</a>
    </li>
    <li>
      <a href="data_agg.html">Data Aggregation</a>
    </li>
    <li>
      <a href="sim_anal.html">Simulation/Analysis</a>
    </li>
    <li>
      <a href="rx_gen.html">Prescription Generation</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Set Up</li>
    <li>
      <a href="postgres_setup.html">PostgreSQL Set Up</a>
    </li>
    <li>
      <a href="create_shp_qgis.html">Create Shapefile</a>
    </li>
    <li>
      <a href="gee_setup.html">Google Earth Engine Set Up</a>
    </li>
    <li>
      <a href="gd_setup.html">Google Drive Set Up</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Annual Tasks</li>
    <li>
      <a href="run_gee.html">Edit/Run Google Earth Engine</a>
    </li>
  </ul>
</li>
<li>
  <a href="contact.html">Contact</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Edit/Run Google Earth Engine</h1>

</div>


<p>Remote sensing data is collected from Google Earth Engine and includes data temporally variable data such as weather and static data such as topogrophy. The user is responsible for running the Google Earth Engine Javascript code to download data for each year required. See this <a href="gee_setup.html">tutorial</a> for adding farm boundaries to GEE as asset and this <a href="gd_setup.html">tutorial</a> for setting up Google Drive to receive your data from Google Earth Engine. See the diagrams on this <a href="dat_import.html">page</a> for an overview of the Google Earth Engine data download.</p>
<p>Besides the section on creating the Google Earth Engine Javascript, the tutorial below outlines a workflow that should be repeated on an annual basis to download data for the past and current year (up to March 30th). Any parameters can be turned off, any selection of farms can be selected, and any years can be selected by the user.</p>
<div id="description" class="section level3">
<h3>Description</h3>
<p>This code is for looping through a sequence of specified years for all farms and downloading all GEE variables for a specified year. The code takes the user selected years and downloads all data for that year up until 03/30. It also downloads the full year’s worth of data for the previous year. This means that the least recent year of data in the database will be 1 minus the least recent year specified in the user selection. The user can select a sequence of years in order, or a string of years to download data for. This code was developed for efficiently downloading previous years data from GEE. However, because the user can specify specific years, this code can be used as the annual run once per year and will download all the variables needed for all the farms for the current year (up to mar) and previous year (full year) when 1 year is specified.In the database these are distinguished by a column labeled ‘mar’ or ‘full’ for up to march and full year, respectively. Note that water years are from November 1 to October 31. User also has control over what variables to collect so not all vars are collected if not desired.</p>
<p>Precipitation and growing degree day information is collected from GRIDMET by the Idaho EPSCoR project and is 4 km resolution with data available from 1979. It is also collected from Daymet V3, by the NASA ORNL group, which is preferred due to it’s 1km reolution. The surfaces data is collected from the USGS National Elevation Dataset at a 10 m scale from prior to 1999. The vegetation index data is collected from different sources based on the date requested. All data 2018 or later are 10 m resolution filtered top of atmosphere measures from the EU’s Copernicus Sentinel 2. Prior to 2018 cy and 2016 py, data is collected from Landsat 5 if before 2012, Landsat 7 for 2012/2013, and Landsat 8 for after. Landsat 8 is collected until present to gap fill. S2 provides NDRE and CLRE (should be CIRE) bands for calculating. For Canadian farms the data is collected from NASA ORNL DaymetV3 at a 1km scale exclusively because the USGS NED is not available. These are estimates. Elevation data is from the National Elevaiton dataset at 10m scale for the USA and from the Canadian Digital Elevation Model at a 20m scale for elevation and SRTM from NASA at a 30m scale for slope, aspect, tpi.</p>
</div>
<div id="naming-convention" class="section level3">
<h3>Naming Convention</h3>
<p>The naming convention for these files are important for the import of the data to the OFPE database. Again, you need to have a Google Drive folder set up with a folder called ‘GEE_Surfaces’ to receive these files. See this <a href="gd_setup.html">tutorial</a> if not set up already. The import code is relatively rigid because this GEE data is under our control and we can nameand format how we like. The import code gathers information about the data from the name of the file so the naming convention becomes important. It would be easiest if these were not changed.</p>
<p><strong>GENERAL FORMAT:</strong> <em>farmername</em>_<em>scale</em>_<em>datasource</em>_<em>measure</em>_<em>current/previous year</em>_<em>year</em>_<em>loy</em>.</p>
<ul>
<li><em>e.g.</em> “<em>farmer</em>_<em>farmname</em>_clre_20m_2013_mar” = 20 m resolution clre data from 2013 up until 03/30 for <em>farmer</em>’s fields at <em>farmname</em></li>
<li><em>or</em> “<em>farmer</em>_<em>farmname</em>_4km_gdd_prevYr_2018” = 4km gdd data from 2018 for <em>farmer</em>’s fields at <em>farmname</em></li>
</ul>
<p><strong>IMPORTANT:</strong> If you change the name of any variable in the filenames, or if you use a new scale, check the GEE import script source code for compatibility.</p>
</div>
<div id="tutorial" class="section level3">
<h3>Tutorial</h3>
<p>This tutorial assumes that the user has already set up a <a href="https://earthengine.google.com/">Google Earth Engine</a> and <a href="https://www.google.com/drive/">Google Drive</a> account. Additionally, it assumes the user has followed the setup instructions in this <a href="create_shp_qgis.html">tutorial</a>, this <a href="gee_setup.html">tutorial</a>, and this <a href="gd_setup.html">tutorial</a>.</p>
</div>
<div id="script-creation" class="section level3">
<h3>Script Creation</h3>
<p>This section of the tutorial is for gathering the OFPE script for gathering all relevant Google Earth Engine (GEE) data.</p>
<p><strong>1.</strong> Download the Javascript code developed for the OFPE project and open the file. This code can also be found <a href="https://github.com/paulhegedus/Google_Earth_Engine/blob/master/OFPE/ogpe_gee_javascript.txt">here</a>.</p>
<a href="data:application/javascript;base64,Ly8gU2NyaXB0IGZvciBjb2xsZWN0aW5nIGFsbCBmYXJtcyBHRUUgdmFyaWFibGVzIGZvciBhIHNwZWNpZmllZCBzZXQvc2VxdWVuY2Ugb2YgeWVhcihzKQovLyBQYXVsIEhlZ2VkdXMgLSAyMDE5MTEwOQovLyBUaGlzIGNvZGUgcnVucyBpbiBHb29nbGUgRWFydGggRW5naW5lIENvZGUgRWRpdG9yLiBGb2xsb3cgdGhlIGxpbmtzIGJlbG93IHRvIHNldCB1cCBhbmQgcHJlcGFyZSAKLy8gR29vZ2xlIERyaXZlLgovLyBodHRwczovL3BhdWxoZWdlZHVzLmdpdGh1Yi5pby9PRlBFLVdlYnNpdGUvZ2VlX3NldHVwLmh0bWwKLy8gaHR0cHM6Ly9wYXVsaGVnZWR1cy5naXRodWIuaW8vT0ZQRS1XZWJzaXRlL2dkX3NldHVwLmh0bWwKLy8gTW9zdCBpbXBvcnRhbnRseSwgdGhlIGxpbmsgYmVsb3csIGZvciB1c2luZyB0aGlzIGNvZGU7Ci8vIGh0dHBzOi8vcGF1bGhlZ2VkdXMuZ2l0aHViLmlvL09GUEUtV2Vic2l0ZS9ydW5fZ2VlLmh0bWwKCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBBc3NldHMgKENPUFkgQU5EIFBBU1RFLCBVTkNPTU1FTlQsICYgSU1QT1JUKQovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy92YXIgZ3JpZG1ldCA9IGVlLkltYWdlQ29sbGVjdGlvbigiSURBSE9fRVBTQ09SL0dSSURNRVQiKSwKLy9uZWQgPSBlZS5JbWFnZSgiVVNHUy9ORUQiKSwKLy9jZGVtID0gZWUuSW1hZ2VDb2xsZWN0aW9uKCJOUkNhbi9DREVNIiksCi8vc3J0bSA9IGVlLkltYWdlKCdVU0dTL1NSVE1HTDFfMDAzJyksCi8vTDdzciA9IGVlLkltYWdlQ29sbGVjdGlvbigiTEFORFNBVC9MRTA3L0MwMS9UMV9TUiIpLAovL3MydG9hID0gZWUuSW1hZ2VDb2xsZWN0aW9uKCJDT1BFUk5JQ1VTL1MyIiksCi8vTDVzciA9IGVlLkltYWdlQ29sbGVjdGlvbigiTEFORFNBVC9MVDA1L0MwMS9UMV9TUiIpLAovL0w4c3IgPSBlZS5JbWFnZUNvbGxlY3Rpb24oIkxBTkRTQVQvTEMwOC9DMDEvVDFfU1IiKSwKLy9zbWFwID0gZWUuSW1hZ2VDb2xsZWN0aW9uKCdOQVNBX1VTREEvSFNML1NNQVBfc29pbF9tb2lzdHVyZScpLAovL2RheW1ldCA9IGVlLkltYWdlQ29sbGVjdGlvbignTkFTQS9PUk5ML0RBWU1FVF9WMycpOyAvLyAKCi8vIE5vdGUgdGhhdCBub3QgYWxsIG9mIHRoZSBzb3VyY2VzIGFib3ZlIGFyZSB1c2VkLCBidXQgYXJlIG9wdGlvbnMuCgovLyBBZ2Fpbiwgc2VlIGh0dHBzOi8vcGF1bGhlZ2VkdXMuZ2l0aHViLmlvL09GUEUtV2Vic2l0ZS9ydW5fZ2VlLmh0bWwgZm9yIHRoZSBkZXNjcmlwdGlvbiBhbmQgdHV0b3JpYWwgb24KLy8gaG93IHRvIHVzZSB0aGlzIGNvZGUuCgovLyBUaGlzIGNvZGUgaXMgZm9yIGxvb3BpbmcgdGhyb3VnaCBhIHNlcXVlbmNlIG9mIHNwZWNpZmllZCB5ZWFycyBmb3IgYWxsIGZhcm1zIAovLyBhbmQgZG93bmxvYWRpbmcgYWxsIEdFRSB2YXJpYWJsZXMgZm9yIGEgc3BlY2lmaWVkIHllYXIuIAoKLy8gUHJlY2lwaXRhdGlvbiBhbmQgZ3Jvd2luZyBkZWdyZWUgZGF5IGluZm9ybWF0aW9uIGlzIGNvbGxlY3RlZCBmcm9tIEdSSURNRVQgYnkgdGhlIElkYWhvIEVQU0NvUiBwcm9qZWN0Ci8vIGFuZCBpcyA0IGttIHJlc29sdXRpb24gd2l0aCBkYXRhIGF2YWlsYWJsZSBmcm9tIDE5NzkuIEl0IGlzIGFsc28gY29sbGVjdGVkIGZyb20gRGF5bWV0IFYzLCBieSB0aGUgCi8vIE5BU0EgT1JOTCBncm91cCwgd2hpY2ggaXMgcHJlZmVycmVkIGR1ZSB0byBpdCdzIDFrbSByZW9sdXRpb24uIFRoZSBzdXJmYWNlcyBkYXRhIGlzIGNvbGxlY3RlZCBmcm9tIHRoZSBVU0dTCi8vIE5hdGlvbmFsIEVsZXZhdGlvbiBEYXRhc2V0IGF0IGEgMTAgbSBzY2FsZSBmcm9tIHByaW9yIHRvIDE5OTkuIFRoZSB2ZWdldGF0aW9uIGluZGV4IGRhdGEgaXMgY29sbGVjdGVkCi8vIGZyb20gZGlmZmVyZW50IHNvdXJjZXMgYmFzZWQgb24gdGhlIGRhdGUgcmVxdWVzdGVkLiBBbGwgZGF0YSAyMDE4IG9yIGxhdGVyIGFyZSAxMCBtIHJlc29sdXRpb24gZmlsdGVyZWQgCi8vIHRvcCBvZiBhdG1vc3BoZXJlIG1lYXN1cmVzIGZyb20gdGhlIEVVJ3MgQ29wZXJuaWN1cyBTZW50aW5lbCAyLiBQcmlvciB0byAyMDE4IGN5IGFuZCAyMDE2IHB5LCBkYXRhCi8vIGlzIGNvbGxlY3RlZCBmcm9tIExhbmRzYXQgNSBpZiBiZWZvcmUgMjAxMiwgTGFuZHNhdCA3IGZvciAyMDEyLzIwMTMsIGFuZCBMYW5kc2F0IDggZm9yIGFmdGVyLiAKLy8gTGFuZHNhdCA4IGlzIGNvbGxlY3RlZCB1bnRpbCBwcmVzZW50IHRvIGdhcCBmaWxsLiBTMiBwcm92aWRlcyBORFJFIGFuZCBDTFJFIChzaG91bGQgYmUgQ0lSRSkgYmFuZHMgZm9yIGNhbGN1bGF0aW5nLiAKLy8gRm9yIENhbmFkaWFuIGZhcm1zIHRoZSBkYXRhIGlzIGNvbGxlY3RlZCBmcm9tIE5BU0EgT1JOTCBEYXltZXRWMyBhdCBhIDFrbSBzY2FsZSBleGNsdXNpdmVseSBiZWNhdXNlIHRoZSAKLy8gVVNHUyBORUQgaXMgbm90IGF2YWlsYWJsZS4gVGhlc2UgYXJlIGVzdGltYXRlcy4gRWxldmF0aW9uIGRhdGEgaXMgZnJvbSB0aGUgTmF0aW9uYWwgRWxldmFpdG9uIGRhdGFzZXQgYXQKLy8gMTBtIHNjYWxlIGZvciB0aGUgVVNBIGFuZCBmcm9tIHRoZSBDYW5hZGlhbiBEaWdpdGFsIEVsZXZhdGlvbiBNb2RlbCBhdCBhIDIwbSBzY2FsZSBmb3IgZWxldmF0aW9uIGFuZCBTUlRNIGZyb20gTkFTQQovLyBhdCBhIDMwbSBzY2FsZSBmb3Igc2xvcGUsIGFzcGVjdCwgdHBpLgoKLy8gTkFNSU5HIENPTlZFTlRJT04KLy8gVGhlIG5hbWluZyBjb252ZW50aW9uIGZvciB0aGVzZSBmaWxlcyBhcmUgaW1wb3J0YW50IGZvciB0aGUgaW1wb3J0IG9mIHRoZSBkYXRhIHRvIHRoZSBPRlBFIGRhdGFiYXNlLiAKLy8gQWdhaW4sIHlvdSBuZWVkIHRvIGhhdmUgYSBHb29nbGUgRHJpdmUgZm9sZGVyIHNldCB1cCB3aXRoIGEgZm9sZGVyIGNhbGxlZCAnR0VFX1N1cmZhY2VzJyB0byByZWNlaXZlIHRoZXNlIGZpbGVzLgovLyBTZWUgdGhpcyBbdHV0b3JpYWxdKGdkX3NldHVwLmh0bWwpIGlmIG5vdCBzZXQgdXAgYWxyZWFkeS4gVGhlIGltcG9ydCBjb2RlIGlzIHJlbGF0aXZlbHkgcmlnaWQgYmVjYXVzZSB0aGlzIAovLyBHRUUgZGF0YSBpcyB1bmRlciBvdXIgY29udHJvbCBhbmQgd2UgY2FuIG5hbWVhbmQgZm9ybWF0IGhvdyB3ZSBsaWtlLiBUaGUgaW1wb3J0IGNvZGUgZ2F0aGVycyBpbmZvcm1hdGlvbiBhYm91dCAKLy8gdGhlIGRhdGEgZnJvbSB0aGUgbmFtZSBvZiB0aGUgZmlsZSBzbyB0aGUgbmFtaW5nIGNvbnZlbnRpb24gYmVjb21lcyBpbXBvcnRhbnQuIEl0IHdvdWxkIGJlIGVhc2llc3QgaWYgdGhlc2UKLy8gd2VyZSBub3QgY2hhbmdlZC4KCi8vIEdFTkVSQUwgRk9STUFUOiA8ZmFybWVybmFtZT5fPHNjYWxlPl88ZGF0YXNvdXJjZT5fPG1lYXN1cmU+XzxjdXJyZW50L3ByZXZpb3VzIHllYXI+Xzx5ZWFyPl88bG95Pi4gCi8vIGUuZy4g4oCcPGZhcm1lcj5fPGZhcm1uYW1lPl9jbHJlXzIwbV8yMDEzX21hcuKAnSA9IAovLyAyMCBtIHJlc29sdXRpb24gY2xyZSBkYXRhIGZyb20gMjAxMyB1cCB1bnRpbCAwMy8zMCBmb3IgPGZhcm1lcj4ncyBmaWVsZHMgYXQgPGZhcm1uYW1lPgovLyAqb3IqICDigJw8ZmFybWVyPl88ZmFybW5hbWU+XzRrbV9nZGRfcHJldllyXzIwMTjigJ0gPSAKLy8gNGttIGdkZCBkYXRhIGZyb20gMjAxOCBmb3IgPGZhcm1lcj4ncyBmaWVsZHMgYXQgPGZhcm1uYW1lPgoKLy8gSU1QT1JUQU5UOiBJZiB5b3UgY2hhbmdlIHRoZSBuYW1lIG9mIGFueSB2YXJpYWJsZSBpbiB0aGUgZmlsZW5hbWVzLCBvciBpZiB5b3UgdXNlIGEgbmV3IHNjYWxlLCAKLy8gY2hlY2sgdGhlIEdFRSBpbXBvcnQgc2NyaXB0IHNvdXJjZSBjb2RlIGZvciBjb21wYXRpYmlsaXR5LgoKCi8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQovLyBVU0VSIElOUFVUUwovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gU2VsZWN0IHZhcnMgdG8gY29sbGVjdCAxPXllcywgMD1ubwp2YXIgcHJlY0NZID0gMTsgCnZhciBwcmVjUFkgPSAxOyAKdmFyIGdkZENZID0gMTsgCnZhciBnZGRQWSA9IDE7IAp2YXIgYXNwZWN0ID0gMTsgCnZhciBzbG9wZUkgPSAxOyAKdmFyIGVsZXYgPSAxOyAKdmFyIHRwaUkgPSAxOyAKdmFyIG5kdmlDWSA9IDE7IAp2YXIgbmR2aVBZID0gMTsgCnZhciBuZHJlQ1kgPSAxOyAKdmFyIG5kcmVQWSA9IDE7IAp2YXIgY2xyZUNZID0gMTsgCnZhciBjbHJlUFkgPSAxOyAKdmFyIHNtYXBDWSA9IDE7CnZhciBzbWFwUFkgPSAxOwoKLy8gU3RyaW5nIG9yIHNlcXVlbmNlIG9mIHllYXJzIHRvIGdldCBkYXRhIGZvcgp2YXIgeWVhcnMgPSBbJzIwMDAnLCcyMDAxJywnMjAwMicsJzIwMDMnLCcyMDA0JywnMjAwNScsJzIwMDYnLCcyMDA3JywnMjAwOCcsJzIwMDknLCcyMDEwJywnMjAxMScsJzIwMTInLCcyMDEzJywnMjAxNCcsJzIwMTUnLCcyMDE2JywnMjAxNycsJzIwMTgnLCcyMDE5JywnMjAyMCddOwoKLy8gU3RyaW5nIG9mIGZhcm1zIChhc3NldHMgdGhhdCBhcmUgaW5nZXN0ZWQgYWxyZWFkeSkgdG8gbG9vcCBvdmVyIChORUVEIHRvIGFkZCBvdGhlcnMgd2hlbiB5b3UgaGF2ZSB0aGVtKQp2YXIgZmFybXMgPSBbJzxmYXJtZXI+XzxmYXJtbmFtZT4nLCc8ZmFybWVyPl88ZmFybW5hbWU+JywnPGZhcm1lcj5fPGZhcm1uYW1lPiddOyAvLwoKLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCi8vIEZ1bmN0aW9ucwovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KLy8gQ2FsY3VsYXRlIEdERCBGdW5jdGlvbnMKdmFyIGdkZFYzID0gZnVuY3Rpb24oaW1hZ2UpewogIHZhciBkYXlzID0gaW1hZ2UuZXhwcmVzc2lvbignKHRtYXggKyB0bWluKS8yIC0gMCcsIHsKICAgICd0bWluJzogaW1hZ2Uuc2VsZWN0KCd0bWluJyksCiAgICAndG1heCc6IGltYWdlLnNlbGVjdCgndG1heCcpCiAgfSk7CiAgcmV0dXJuIGRheXMucmVuYW1lKFsnZ2RkJ10pLnVwZGF0ZU1hc2soZGF5cy5ndCgwKSk7Cn07CnZhciBnZGQgPSBmdW5jdGlvbihpbWFnZSl7CiAgdmFyIGRheXMgPSBpbWFnZS5leHByZXNzaW9uKCcodG1tbiArIHRtbXgpLzIgLSAoMCArIDI3My4xNSknLCB7CiAgICAndG1tbic6IGltYWdlLnNlbGVjdCgndG1tbicpLAogICAgJ3RtbXgnOiBpbWFnZS5zZWxlY3QoJ3RtbXgnKQogIH0pOwogIHJldHVybiBkYXlzLnJlbmFtZShbJ2dkZCddKS51cGRhdGVNYXNrKGRheXMuZ3QoMCkpOwp9OwovLyBEZWZpbmUgYSBmdW5jdGlvbiB0byBjb252ZXJ0IGZyb20gZGVncmVlcyB0byByYWRpYW5zIGZvciBhc3BlY3QKdmFyIHJhZGlhbnMgPSBmdW5jdGlvbihpbWcpIHsKICByZXR1cm4gaW1nLnRvRmxvYXQoKS5tdWx0aXBseShNYXRoLlBJKS5kaXZpZGUoMTgwKTsKfTsKLy8gRnVuY3Rpb24gdG8gbWFzayBjbG91ZHMgdXNpbmcgdGhlIFNlbnRpbmVsLTIgUUEgYmFuZC4KdmFyIG1hc2tTMmNsb3VkcyA9IGZ1bmN0aW9uKGltYWdlKSB7CiAgdmFyIHFhID0gaW1hZ2Uuc2VsZWN0KCdRQTYwJyk7CiAgLy8gQml0cyAxMCBhbmQgMTEgYXJlIGNsb3VkcyBhbmQgY2lycnVzLCByZXNwZWN0aXZlbHkuCiAgdmFyIGNsb3VkQml0TWFzayA9IDEgPDwgMTA7CiAgdmFyIGNpcnJ1c0JpdE1hc2sgPSAxIDw8IDExOwogIC8vIEJvdGggZmxhZ3Mgc2hvdWxkIGJlIHNldCB0byB6ZXJvLCBpbmRpY2F0aW5nIGNsZWFyIGNvbmRpdGlvbnMuCiAgdmFyIG1hc2sgPSBxYS5iaXR3aXNlQW5kKGNsb3VkQml0TWFzaykuZXEoMCkuYW5kKAogICAgcWEuYml0d2lzZUFuZChjaXJydXNCaXRNYXNrKS5lcSgwKSk7CiAgLy8gUmV0dXJuIHRoZSBtYXNrZWQgYW5kIHNjYWxlZCBkYXRhLCB3aXRob3V0IHRoZSBRQSBiYW5kcy4KICByZXR1cm4gaW1hZ2UudXBkYXRlTWFzayhtYXNrKS5kaXZpZGUoMTAwMDApCiAgICAuc2VsZWN0KCJCLioiKQogICAgLmNvcHlQcm9wZXJ0aWVzKGltYWdlLCBbInN5c3RlbTp0aW1lX3N0YXJ0Il0pOwp9OwovLyBGdW5jdGlvbiB0byBtYXNrIGNsb3VkcyB1c2luZyB0aGUgTGFuZHNhdCA4IGJhbmRzCnZhciBtYXNrTDhzciA9IGZ1bmN0aW9uKGltYWdlKSB7CiAgLy8gQml0cyAzIGFuZCA1IGFyZSBjbG91ZCBzaGFkb3cgYW5kIGNsb3VkLCByZXNwZWN0aXZlbHkuCiAgdmFyIGNsb3VkU2hhZG93Qml0TWFzayA9ICgxIDw8IDMpOwogIHZhciBjbG91ZHNCaXRNYXNrID0gKDEgPDwgNSk7CiAgLy8gR2V0IHRoZSBwaXhlbCBRQSBiYW5kLgogIHZhciBxYSA9IGltYWdlLnNlbGVjdCgncGl4ZWxfcWEnKTsKICAvLyBCb3RoIGZsYWdzIHNob3VsZCBiZSBzZXQgdG8gemVybywgaW5kaWNhdGluZyBjbGVhciBjb25kaXRpb25zLgogIHZhciBtYXNrID0gcWEuYml0d2lzZUFuZChjbG91ZFNoYWRvd0JpdE1hc2spLmVxKDApCiAgICAuYW5kKHFhLmJpdHdpc2VBbmQoY2xvdWRzQml0TWFzaykuZXEoMCkpOwogIHJldHVybiBpbWFnZS51cGRhdGVNYXNrKG1hc2spOwp9OwovLyBjYWxjdWxhdGVzIG5kdmkgQCAzMG0gcmVzb2x1dGlvbiBmcm9tIExhbmRzYXQgNCwgNSwgYW5kIDcgc3VyZmFjZSByZWZsZWN0YW5jZQp2YXIgY2xvdWRNYXNrTDQ1NyA9IGZ1bmN0aW9uKGltYWdlKSB7CiAgdmFyIHFhID0gaW1hZ2Uuc2VsZWN0KCdwaXhlbF9xYScpOwogIC8vIElmIHRoZSBjbG91ZCBiaXQgKDUpIGlzIHNldCBhbmQgdGhlIGNsb3VkIGNvbmZpZGVuY2UgKDcpIGlzIGhpZ2gKICAvLyBvciB0aGUgY2xvdWQgc2hhZG93IGJpdCBpcyBzZXQgKDMpLCB0aGVuIGl0J3MgYSBiYWQgcGl4ZWwuCiAgdmFyIGNsb3VkID0gcWEuYml0d2lzZUFuZCgxIDw8IDUpCiAgICAuYW5kKHFhLmJpdHdpc2VBbmQoMSA8PCA3KSkKICAgIC5vcihxYS5iaXR3aXNlQW5kKDEgPDwgMykpOwogIC8vIFJlbW92ZSBlZGdlIHBpeGVscyB0aGF0IGRvbid0IG9jY3VyIGluIGFsbCBiYW5kcwogIHZhciBtYXNrMiA9IGltYWdlLm1hc2soKS5yZWR1Y2UoZWUuUmVkdWNlci5taW4oKSk7CiAgcmV0dXJuIGltYWdlLnVwZGF0ZU1hc2soY2xvdWQubm90KCkpLnVwZGF0ZU1hc2sobWFzazIpOwp9OwoKLy8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCi8vIFNUQVJUIENPREUKLy8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCi8vIHN0YXJ0IGxvb3AgdGhyb3VnaCB5ZWFycwovLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KdmFyIGo9MDsKZm9yKGo7IGogPCB5ZWFycy5sZW5ndGg7IGorKyl7CiAgdmFyIENZID0geWVhcnNbal07CiAgdmFyIFBZID0gQ1kgLSAxOwogIC8vIHN0YXJ0IGZvciBsb29wIHRocm91Z2ggZmFybXMKICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICB2YXIgaT0wOyAKICBmb3IoaTsgaSA8IGZhcm1zLmxlbmd0aDsgaSsrKXsKICAgIC8vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgLy8gc2V0IHVwIGFzc2V0cwogICAgLy8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgICB2YXIgdGFibGUgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbigidXNlcnMvPEdPT0dMRSBBQ0NPVU5UIFVTRVJOQU1FPi8iICsgZmFybXNbaV0gKyAiX2Jib3giKTsgCiAgICAvLyBeSU1QT1JUQU5UXjogTW9kaWZ5IHRoaXMgcGF0aCBhcyBuZWVkZWQuIEZvciBleGFtcGxlLCByZW1vdmUgIl9iYm94IiBpZiB0aGF0IGlzIG5vdCBpbiB5b3VyIGFzc2V0IG5hbWVzLgogICAgdmFyIGZhcm1fbmFtZSA9IHRhYmxlOwogICAgdmFyIGN1cnJlbnRfZmFybSA9IGZhcm1zW2ldOwogICAgLy9NYXAuYWRkTGF5ZXIoZmFybV9uYW1lLHt9LCBjdXJyZW50X2Zhcm0gKyAnX2Jib3gnLCB0cnVlKTsKICAgIAogICAgLy8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKgogICAgLy8gU1RBUlQgQ09ERSBGT1IgRkFSTWkgWUVBUmoKICAgIC8vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBDTElNQVRFIFZBUklBQkxFUyAoUFJFQywgR0REKQogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIENsaW1hdGUgdmFyaWFibGVzIGluIE5vcnRoIEFtZXJpY2EgY29sbGVjZXRlZCBmcm9tIE5BU0EgT1JOTAogICAgLy8gRGF5bWV0VjMgZGF0YXNldCAoMWttKQogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBQcmVjaXBpdGF0aW9uCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFBSRUMgQ1kKICAgIGlmKHByZWNDWT09MSl7CiAgICAgIC8vdXNlIG1vbnRoLWRheSBvZiAxMS0wMSBhbmQgMDMtMzAgZm9yIHByZWMgdGhydSBtYXJjaCBvZiBjdXJyZW50IGdyb3cgeXIsIAogICAgICB2YXIgY3VyclllYXIgPSBDWTsKICAgICAgdmFyIHN0YXJ0RGF0ZSA9IFBZICsgJy0xMS0wMSc7CiAgICAgIHZhciBlbmREYXRlID0gIENZICsgJy0wMy0zMCc7CiAgICAgIC8vIHNlbGVjdCBmb3IgcHJlY2lwIGRhdGEKICAgICAgdmFyIHByZWNpcCA9IGRheW1ldC5zZWxlY3QoJ3ByY3AnKQogICAgICAgIC5maWx0ZXJEYXRlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSkKICAgICAgICAuc3VtKCk7CiAgICAgIC8vIENsaXAgUHJlY2lwIGltYWdlcwogICAgICB2YXIgbWFzayA9IGVlLkZlYXR1cmVDb2xsZWN0aW9uKGZhcm1fbmFtZSk7CiAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICB2YXIgcHJlY2lwX3N1bV9jeV9jbGlwcGVkID0gcHJlY2lwLmNsaXAobWFzayk7CiAgICAgIC8vZXhwb3J0IHRvIGdvb2dsZSBkcml2ZSAgICAgICAgCiAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICBpbWFnZTogcHJlY2lwX3N1bV9jeV9jbGlwcGVkLAogICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnXzFrbV9kYXltZXRfcHJlY19jdXJyWXJfJyArIGN1cnJZZWFyLAogICAgICAgIGZvbGRlcjonR0VFX1N1cmZhY2VzJywKICAgICAgICBjcnM6ICdFUFNHOjQzMjYnLCAvLyBzYXZlcyBpdCBhcyBsb25nIGxhdCB3Z3M4NCAocmVwcm9qZWN0ZWQgZm9yIHNwYXRpYWwgYW5hbHlzaXMpCiAgICAgICAgc2NhbGU6IDEwLAogICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICB9KTsKICAgIH0gLy8gRU5EIFBSRUMgQ1kKICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUFJFQyBQWQogICAgaWYocHJlY1BZPT0xKXsKICAgICAgLy91c2UgMTEtMDEgYW5kIDEwLTMxIGZvciBwcmV2IGdyb3cgeXIKICAgICAgdmFyIHByZXZZZWFyID0gUFk7CiAgICAgIHZhciBzdGFydERhdGUgPSBQWS0xICsnLTExLTAxJzsKICAgICAgdmFyIGVuZERhdGUgPSAgUFkgKyAnLTEwLTMxJzsKICAgICAgLy8gc2VsZWN0IGZvciBwcmVjaXAgZGF0YQogICAgICB2YXIgcHJlY2lwID0gZGF5bWV0LnNlbGVjdCgncHJjcCcpCiAgICAgICAgLmZpbHRlckRhdGUoc3RhcnREYXRlLCBlbmREYXRlKQogICAgICAgIC5zdW0oKTsKICAgICAgLy8gQ2xpcCBQcmVjaXAgaW1hZ2VzCiAgICAgIHZhciBtYXNrID0gZWUuRmVhdHVyZUNvbGxlY3Rpb24oZmFybV9uYW1lKTsKICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgIHZhciBwcmVjaXBfc3VtX3B5X2NsaXBwZWQgPSBwcmVjaXAuY2xpcChtYXNrKTsKICAgICAgLy9leHBvcnQgdG8gZ29vZ2xlIGRyaXZlCiAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICBpbWFnZTogcHJlY2lwX3N1bV9weV9jbGlwcGVkLAogICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnXzFrbV9kYXltZXRfcHJlY19wcmV2WXJfJyArIHByZXZZZWFyLAogICAgICAgIGZvbGRlcjonR0VFX1N1cmZhY2VzJywKICAgICAgICBjcnM6ICdFUFNHOjQzMjYnLAogICAgICAgIHNjYWxlOiAxMCwKICAgICAgICByZWdpb246IG1hc2tfZ2VvbWV0cnkKICAgICAgfSk7CiAgICB9IC8vIEVORCBQUkVDIFBZCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEdyb3dpbmcgRGVncmVlIERheXMKICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gR0REIENZCiAgICBpZihnZGRDWT09MSl7CiAgICAgIHZhciBncm93X3lyID0gQ1k7CiAgICAgIC8vdXNlIHRoaXMgYmxvY2sgZm9yIGdkZCBmcm9tIGphbiAxIHRvIG1hciAzMCBvZiBjdXJyZW50IHlyIChjdXJyZW50IHllYXIpCiAgICAgIHZhciBnZGRfY3kgPSBkYXltZXQgCiAgICAgICAgLmZpbHRlckRhdGUoZ3Jvd195ci50b1N0cmluZygpLCAoZ3Jvd195ciArIDEpLnRvU3RyaW5nKCkpCiAgICAgICAgLmZpbHRlcihlZS5GaWx0ZXIuZGF5T2ZZZWFyKDEsIDkwKSkKICAgICAgICAubWFwKGdkZFYzKQogICAgICAgIC5zdW0oKTsKICAgICAgLy8gQ2xpcCBHREQgaW1hZ2VzCiAgICAgIHZhciBtYXNrID0gZWUuRmVhdHVyZUNvbGxlY3Rpb24oZmFybV9uYW1lKTsKICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgIHZhciBnZGRfY3lfY2xpcCA9ICBnZGRfY3kuY2xpcChtYXNrKTsgCiAgICAgIC8vZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICBFeHBvcnQuaW1hZ2UudG9Ecml2ZSh7CiAgICAgICAgaW1hZ2U6IGdkZF9jeV9jbGlwLCAvLwogICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnXzFrbV9kYXltZXRfZ2RkX2N1cnJZcl8nICsgZ3Jvd195ciwgCiAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgc2NhbGU6IDEwLAogICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICB9KTsKICAgIH0gLy8gRU5EIENZIEdERAogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBHREQgUFkKICAgIGlmKGdkZFBZPT0xKXsKICAgICAgdmFyIGdyb3dfUHJldllyID0gUFk7CiAgICAgIC8vIHVzZSB0aGlzIGJsb2NrIGZvciBnZGQgZnJvbSBqYW4gMSB0aHJ1IGp1biAzMCBvZiBwcmV2IGdyb3cgeXIgKHByZXYgeXIpCiAgICAgIHZhciBnZGRfcHkgPSBkYXltZXQKICAgICAgICAuZmlsdGVyRGF0ZShncm93X1ByZXZZci50b1N0cmluZygpLCAoZ3Jvd19QcmV2WXIgKyAxKS50b1N0cmluZygpKQogICAgICAgIC5maWx0ZXIoZWUuRmlsdGVyLmRheU9mWWVhcigxLCAxODApKQogICAgICAgIC5tYXAoZ2RkVjMpCiAgICAgICAgLnN1bSgpOwogICAgICAvLyBDbGlwIEdERCBpbWFnZXMKICAgICAgdmFyIG1hc2sgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbihmYXJtX25hbWUpOwogICAgICB2YXIgbWFza19nZW9tZXRyeSA9IG1hc2suZ2VvbWV0cnkoKS5ib3VuZHMoKTsKICAgICAgdmFyIGdkZF9weV9jbGlwID0gZ2RkX3B5LmNsaXAobWFzayk7IC8vCiAgICAgIC8vZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICBFeHBvcnQuaW1hZ2UudG9Ecml2ZSh7CiAgICAgICAgaW1hZ2U6IGdkZF9weV9jbGlwLCAKICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ18xa21fZGF5bWV0X2dkZF9wcmV2WXJfJyArIGdyb3dfUHJldllyLCAKICAgICAgICBmb2xkZXI6J0dFRV9TdXJmYWNlcycsCiAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICBzY2FsZTogMTAsCiAgICAgICAgcmVnaW9uOiBtYXNrX2dlb21ldHJ5CiAgICAgIH0pOwogICAgfSAvLyBFTkQgUFkgR0REICAgCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gQ2xpbWF0ZSB2YXJpYWJsZXMgaW4gdGhlIFVTQSBjb2xsZWNldGVkIGZyb20gVW9mSWRhaG8KICAgIC8vIEdSSURNRVQgZGF0YXNldCAoNGttKQogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBQcmVjaXBpdGF0aW9uCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFBSRUMgQ1kgCiAgICBpZihwcmVjQ1k9PTEpewogICAgICAvL3VzZSBtb250aC1kYXkgb2YgMTEtMDEgYW5kIDAzLTMwIGZvciBwcmVjIHRocnUgbWFyY2ggb2YgY3VycmVudCBncm93IHlyLCAKICAgICAgdmFyIGN1cnJZZWFyID0gQ1k7CiAgICAgIHZhciBzdGFydERhdGUgPSBQWSArICctMTEtMDEnOwogICAgICB2YXIgZW5kRGF0ZSA9ICBDWSArICctMDMtMzAnOwogICAgICAvLyBzZWxlY3QgZm9yIHByZWNpcCBkYXRhCiAgICAgIHZhciBwcmVjaXAgPSBncmlkbWV0LnNlbGVjdCgncHInKQogICAgICAgIC5maWx0ZXJEYXRlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSkKICAgICAgICAuc3VtKCk7CiAgICAgIC8vIENsaXAgUHJlY2lwIGltYWdlcwogICAgICB2YXIgbWFzayA9IGVlLkZlYXR1cmVDb2xsZWN0aW9uKGZhcm1fbmFtZSk7CiAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICB2YXIgcHJlY2lwX3N1bV9jeV9jbGlwcGVkID0gcHJlY2lwLmNsaXAobWFzayk7CiAgICAgIC8vZXhwb3J0IHRvIGdvb2dsZSBkcml2ZSAgICAgICAgCiAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICBpbWFnZTogcHJlY2lwX3N1bV9jeV9jbGlwcGVkLAogICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnXzRrbV9ncmlkbWV0X3ByZWNfY3VycllyXycgKyBjdXJyWWVhciwKICAgICAgICBmb2xkZXI6J0dFRV9TdXJmYWNlcycsCiAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywgLy8gc2F2ZXMgaXQgYXMgbG9uZyBsYXQgd2dzODQgKHJlcHJvamVjdGVkIGZvciBzcGF0aWFsIGFuYWx5c2lzKQogICAgICAgIHNjYWxlOiAxMCwKICAgICAgICByZWdpb246IG1hc2tfZ2VvbWV0cnkKICAgICAgfSk7CiAgICB9IC8vIEVORCBQUkVDIENZCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIFBSRUMgUFkKICAgIGlmKHByZWNQWT09MSl7CiAgICAgIC8vdXNlIDExLTAxIGFuZCAxMC0zMSBmb3IgcHJldiBncm93IHlyCiAgICAgIHZhciBwcmV2WWVhciA9IFBZOwogICAgICB2YXIgc3RhcnREYXRlID0gUFktMSArJy0xMS0wMSc7CiAgICAgIHZhciBlbmREYXRlID0gIFBZICsgJy0xMC0zMSc7CiAgICAgIC8vIHNlbGVjdCBmb3IgcHJlY2lwIGRhdGEKICAgICAgdmFyIHByZWNpcCA9IGdyaWRtZXQuc2VsZWN0KCdwcicpCiAgICAgICAgLmZpbHRlckRhdGUoc3RhcnREYXRlLCBlbmREYXRlKQogICAgICAgIC5zdW0oKTsKICAgICAgLy8gQ2xpcCBQcmVjaXAgaW1hZ2VzCiAgICAgIHZhciBtYXNrID0gZWUuRmVhdHVyZUNvbGxlY3Rpb24oZmFybV9uYW1lKTsKICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgIHZhciBwcmVjaXBfc3VtX3B5X2NsaXBwZWQgPSBwcmVjaXAuY2xpcChtYXNrKTsKICAgICAgLy9leHBvcnQgdG8gZ29vZ2xlIGRyaXZlCiAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICBpbWFnZTogcHJlY2lwX3N1bV9weV9jbGlwcGVkLAogICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnXzRrbV9ncmlkbWV0X3ByZWNfcHJldllyXycgKyBwcmV2WWVhciwKICAgICAgICBmb2xkZXI6J0dFRV9TdXJmYWNlcycsCiAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICBzY2FsZTogMTAsCiAgICAgICAgcmVnaW9uOiBtYXNrX2dlb21ldHJ5CiAgICAgIH0pOwogICAgfSAvLyBFTkQgUFJFQyBQWQogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLyBHcm93aW5nIERlZ3JlZSBEYXlzCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vIEdERCBDWQogICAgaWYoZ2RkQ1k9PTEpewogICAgICB2YXIgZ3Jvd195ciA9IENZOwogICAgICAvL3VzZSB0aGlzIGJsb2NrIGZvciBnZGQgZnJvbSBqYW4gMSB0byBtYXIgMzAgb2YgY3VycmVudCB5ciAoY3VycmVudCB5ZWFyKQogICAgICB2YXIgZ2RkX2N5ID0gZ3JpZG1ldCAKICAgICAgICAuZmlsdGVyRGF0ZShncm93X3lyLnRvU3RyaW5nKCksIChncm93X3lyICsgMSkudG9TdHJpbmcoKSkKICAgICAgICAuZmlsdGVyKGVlLkZpbHRlci5kYXlPZlllYXIoMSwgOTApKQogICAgICAgIC5tYXAoZ2RkKQogICAgICAgIC5zdW0oKTsKICAgICAgLy8gQ2xpcCBHREQgaW1hZ2VzCiAgICAgIHZhciBtYXNrID0gZWUuRmVhdHVyZUNvbGxlY3Rpb24oZmFybV9uYW1lKTsKICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgIHZhciBnZGRfY3lfY2xpcCA9ICBnZGRfY3kuY2xpcChtYXNrKTsgCiAgICAgIC8vZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICBFeHBvcnQuaW1hZ2UudG9Ecml2ZSh7CiAgICAgICAgaW1hZ2U6IGdkZF9jeV9jbGlwLCAvLwogICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnXzRrbV9ncmlkbWV0X2dkZF9jdXJyWXJfJyArIGdyb3dfeXIsIAogICAgICAgIGZvbGRlcjonR0VFX1N1cmZhY2VzJywKICAgICAgICBjcnM6ICdFUFNHOjQzMjYnLAogICAgICAgIHNjYWxlOiAxMCwKICAgICAgICByZWdpb246IG1hc2tfZ2VvbWV0cnkKICAgICAgfSk7CiAgICB9IC8vIEVORCBDWSBHREQKICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gR0REIFBZCiAgICBpZihnZGRQWT09MSl7CiAgICAgIHZhciBncm93X1ByZXZZciA9IFBZOwogICAgICAvLyB1c2UgdGhpcyBibG9jayBmb3IgZ2RkIGZyb20gamFuIDEgdGhydSBqdW4gMzAgb2YgcHJldiBncm93IHlyIChwcmV2IHlyKQogICAgICB2YXIgZ2RkX3B5ID0gZ3JpZG1ldAogICAgICAgIC5maWx0ZXJEYXRlKGdyb3dfUHJldllyLnRvU3RyaW5nKCksIChncm93X1ByZXZZciArIDEpLnRvU3RyaW5nKCkpCiAgICAgICAgLmZpbHRlcihlZS5GaWx0ZXIuZGF5T2ZZZWFyKDEsIDE4MCkpCiAgICAgICAgLm1hcChnZGQpCiAgICAgICAgLnN1bSgpOwogICAgICAvLyBDbGlwIEdERCBpbWFnZXMKICAgICAgdmFyIG1hc2sgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbihmYXJtX25hbWUpOwogICAgICB2YXIgbWFza19nZW9tZXRyeSA9IG1hc2suZ2VvbWV0cnkoKS5ib3VuZHMoKTsKICAgICAgdmFyIGdkZF9weV9jbGlwID0gZ2RkX3B5LmNsaXAobWFzayk7IC8vCiAgICAgIC8vZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICBFeHBvcnQuaW1hZ2UudG9Ecml2ZSh7CiAgICAgICAgaW1hZ2U6IGdkZF9weV9jbGlwLCAKICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ180a21fZ3JpZG1ldF9nZGRfcHJldllyXycgKyBncm93X1ByZXZZciwgCiAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgc2NhbGU6IDEwLAogICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICB9KTsKICAgIH0gLy8gRU5EIFBZIEdERAogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBWQVJJQUJMRVMgRlJPTSBFTEVWQVRJT04gREFUQVNFVFMgKEVMRVYsU0xPUEUsQVNQRUNULFRQSSkKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gVVNHUyBOQVRJT05BTCBFTEVWQVRJT04gREFUQVNFVAogICAgLy8gZG93bmxvYWRzIGVsZXZhdGlvbiBkYXRhLCBjYWxjdWxhdGVzIHNsb3BlLCBhc3BlY3QsIHRwaSBmcm9tIFVTR1MgTmF0aW9uYWwgCiAgICAvLyBFbGV2YXRpb24gRGF0YXNldCAoTkVEKTsgCiAgICAvLyBAIDEvMyBhcmMtc2Vjb25kIHJlc29sdXRpb24gKDEwbSkgY2xpcHBlZCB0byBmYXJtIGJvdW5kYXJ5IGJveAogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIHZhciB5ZWFyID0gQ1k7CiAgICAvLyBFTEVWQVRJT04KICAgIGlmKGVsZXY9PTEpewogICAgICB2YXIgbWFzayA9IGZhcm1fbmFtZTsKICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgIHZhciBkZW1fY2xpcCA9IG5lZC5jbGlwKG1hc2spOwogICAgICAvL2V4cG9ydCB0byBnb29nbGUgZHJpdmUKICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgIGltYWdlOiBkZW1fY2xpcCwgIC8vCiAgICAgICAgZGVzY3JpcHRpb246IGN1cnJlbnRfZmFybSArICdfZWxldl9uZWRfMTBtXycgKyB5ZWFyLCAvLyAKICAgICAgICBmb2xkZXI6J0dFRV9TdXJmYWNlcycsCiAgICAgICAgc2NhbGU6IDEwLAogICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgcmVnaW9uOiBtYXNrX2dlb21ldHJ5CiAgICAgIH0pOwogICAgfQogICAgLy8gQVNQRUNUX1JBRAogICAgaWYoYXNwZWN0PT0xKXsKICAgICAgdmFyIHRlcnJhaW4gPSBlZS5BbGdvcml0aG1zLlRlcnJhaW4obmVkKTsgLy8gQ2FsY3VsYXRlcyBzbG9wZSwgYXNwZWN0LCBhbmQgYSBzaW1wbGUgaGlsbHNoYWRlIGZyb20gYSB0ZXJyYWluIERFTS4KICAgICAgdmFyIGFzcGVjdF9yYWQgPSByYWRpYW5zKHRlcnJhaW4uc2VsZWN0KCdhc3BlY3QnKSkuZmxvYXQoKTsKICAgICAgdmFyIG1hc2sgPSBmYXJtX25hbWU7CiAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICB2YXIgYXNwZWN0X3JhZF9jbGlwID0gYXNwZWN0X3JhZC5jbGlwKG1hc2spOwogICAgICAvL2V4cG9ydCB0byBnb29nbGUgZHJpdmUKICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgIGltYWdlOiBhc3BlY3RfcmFkX2NsaXAsICAKICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ19hc3BlY3RfcmFkX25lZF8xMG1fJyArIHllYXIsIAogICAgICAgIGZvbGRlcjonR0VFX1N1cmZhY2VzJywKICAgICAgICBzY2FsZTogMTAsCiAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICByZWdpb246IG1hc2tfZ2VvbWV0cnkKICAgICAgfSk7CiAgICB9CiAgICAvLyBTTE9QRQogICAgaWYoc2xvcGVJPT0xKXsKICAgICAgdmFyIHRlcnJhaW4gPSBlZS5BbGdvcml0aG1zLlRlcnJhaW4obmVkKTsgLy8gQ2FsY3VsYXRlcyBzbG9wZSwgYXNwZWN0LCBhbmQgYSBzaW1wbGUgaGlsbHNoYWRlIGZyb20gYSB0ZXJyYWluIERFTS4KICAgICAgdmFyIHNsb3BlID0gdGVycmFpbi5zZWxlY3QoJ3Nsb3BlJykuZmxvYXQoKTsKICAgICAgdmFyIG1hc2sgPSBmYXJtX25hbWU7CiAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICB2YXIgc2xvcGVfY2xpcCA9IHNsb3BlLmNsaXAobWFzayk7CiAgICAgIC8vZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICBFeHBvcnQuaW1hZ2UudG9Ecml2ZSh7CiAgICAgICAgaW1hZ2U6IHNsb3BlX2NsaXAsICAvLwogICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnX3Nsb3BlX25lZF8xMG1fJyArIHllYXIsIC8vIAogICAgICAgIGZvbGRlcjonR0VFX1N1cmZhY2VzJywKICAgICAgICBzY2FsZTogMTAsCiAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICByZWdpb246IG1hc2tfZ2VvbWV0cnkKICAgICAgfSk7CiAgICB9CiAgICAvLyBUUEkgMzBtCiAgICBpZih0cGlJPT0xKXsKICAgICAgLy8gY2FsY3VsYXRlIFRQSQogICAgICB2YXIgc2NhbGUgPSAxMDsgLy8gc2NhbGUgaW4gbQogICAgICB2YXIgdHBpX3JhZGl1cyA9IDMqc2NhbGU7IC8vIDMgKiAxMG0gPSAzMG0gcmVzLgogICAgICB2YXIgdHBpID0gbmVkLnN1YnRyYWN0KG5lZC5mb2NhbF9tZWFuKHRwaV9yYWRpdXMsICdjaXJjbGUnLCAnbWV0ZXJzJykpLmFkZCgwLjUpOwogICAgICB2YXIgbWFzayA9IGZhcm1fbmFtZTsKICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgIHZhciB0cGlfY2xpcCA9IHRwaS5jbGlwKG1hc2spOwogICAgICAvL2V4cG9ydCB0byBnb29nbGUgZHJpdmUKICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgIGltYWdlOiB0cGlfY2xpcCwgIC8vIAogICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnX3RwaV9uZWRfMTBtXycgKyB5ZWFyLCAvLwogICAgICAgIGZvbGRlcjonR0VFX1N1cmZhY2VzJywKICAgICAgICBzY2FsZTogMTAsCiAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICByZWdpb246IG1hc2tfZ2VvbWV0cnkKICAgICAgfSk7CiAgICB9CiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIFNNQVAgLSBTb2lsIE1vaXN0dXJlIEFjdGl2ZSBQYXNzaXZlICgyMGttICkKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGlmKHNtYXBDWT09MSl7CiAgICAgIHZhciB5ZWFyID0gQ1k7IC8vICAKICAgICAgaWYoQ1kgPj0gMjAxNil7CiAgICAgICAgdmFyIGN1cnJZZWFyID0gQ1k7CiAgICAgICAgdmFyIHN0YXJ0RGF0ZSA9IFBZICsgJy0xMS0wMSc7CiAgICAgICAgdmFyIGVuZERhdGUgPSAgQ1kgKyAnLTAzLTMwJzsKICAgICAgICB2YXIgbWFzayA9IGVlLkZlYXR1cmVDb2xsZWN0aW9uKGZhcm1fbmFtZSk7CiAgICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgICAgLy8gU1VSRkFDRSBTT0lMIE1PSVNUVVJFIChtbSkgMjBrbSBANDVOCiAgICAgICAgdmFyIHNzbUNZID0gc21hcC5zZWxlY3QoJ3NzbScpIC8vLnNlbGVjdCgnc3NtJykKICAgICAgICAgIC5maWx0ZXJEYXRlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSkKICAgICAgICAgIC5maWx0ZXJCb3VuZHMobWFza19nZW9tZXRyeSkKICAgICAgICAgIC5tYXAoZnVuY3Rpb24oaW1hZ2Upe3JldHVybiBpbWFnZS5jbGlwKG1hc2tfZ2VvbWV0cnkpfSkgOwogICAgICAgIHZhciBzc21DWSA9IHNzbUNZLnJlZHVjZShlZS5SZWR1Y2VyLm1lZGlhbigpKTsKICAgICAgICAvLyBTVUJTVVJGQUNFIFNPSUwgTU9JU1RVUkUgKG1tKSAyMGttIEA0NU4KICAgICAgICB2YXIgc3VzbUNZID0gc21hcC5zZWxlY3QoJ3N1c20nKQogICAgICAgICAgLmZpbHRlckRhdGUoc3RhcnREYXRlLCBlbmREYXRlKQogICAgICAgICAgLmZpbHRlckJvdW5kcyhtYXNrX2dlb21ldHJ5KQogICAgICAgICAgLm1hcChmdW5jdGlvbihpbWFnZSl7cmV0dXJuIGltYWdlLmNsaXAobWFza19nZW9tZXRyeSl9KSA7CiAgICAgICAgdmFyIHN1c21DWSA9IHN1c21DWS5yZWR1Y2UoZWUuUmVkdWNlci5tZWRpYW4oKSk7CiAgICAgICAgLy8gZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICAgIGltYWdlOiBzc21DWSwKICAgICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnX3NzbV9zbWFwXzIwa20nICArICdfJyArIHllYXIgKyAnX21hcicsCiAgICAgICAgICBmb2xkZXI6J0dFRV9TdXJmYWNlcycsCiAgICAgICAgICBzY2FsZTogMTAsCiAgICAgICAgICBjcnM6ICdFUFNHOjQzMjYnLAogICAgICAgICAgcmVnaW9uOiBtYXNrX2dlb21ldHJ5CiAgICAgICAgfSk7CiAgICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgICAgaW1hZ2U6IHN1c21DWSwKICAgICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnX3N1c21fc21hcF8yMGttJyAgKyAnXycgKyB5ZWFyICsgJ19tYXInLAogICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgc2NhbGU6IDEwLAogICAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgIH0pOwogICAgICB9IC8vIEVORCBJRiBZRUFSID49IDIwMTYKICAgICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIH0gLy8gRU5EIENZIFNNQVAKICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgaWYoc21hcFBZPT0xKXsKICAgICAgdmFyIHllYXIgPSBQWTsgLy8gIAogICAgICBpZihDWSA+PSAyMDE2KXsKICAgICAgICB2YXIgcHJldlllYXIgPSBQWTsKICAgICAgICB2YXIgc3RhcnREYXRlID0gUFktMSArJy0xMS0wMSc7CiAgICAgICAgdmFyIGVuZERhdGUgPSAgUFkgKyAnLTEwLTMxJzsKICAgICAgICB2YXIgbWFzayA9IGVlLkZlYXR1cmVDb2xsZWN0aW9uKGZhcm1fbmFtZSk7CiAgICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgICAgLy8gU1VSRkFDRSBTT0lMIE1PSVNUVVJFIChtbSkgMjBrbSBANDVOCiAgICAgICAgdmFyIHNzbVBZID0gc21hcC5zZWxlY3QoJ3NzbScpCiAgICAgICAgICAuZmlsdGVyRGF0ZShzdGFydERhdGUsIGVuZERhdGUpCiAgICAgICAgICAuZmlsdGVyQm91bmRzKG1hc2tfZ2VvbWV0cnkpCiAgICAgICAgICAubWFwKGZ1bmN0aW9uKGltYWdlKXtyZXR1cm4gaW1hZ2UuY2xpcChtYXNrX2dlb21ldHJ5KX0pIDsKICAgICAgICB2YXIgc3NtUFkgPSBzc21QWS5yZWR1Y2UoZWUuUmVkdWNlci5tZWRpYW4oKSk7CiAgICAgICAgLy8gU1VCU1VSRkFDRSBTT0lMIE1PSVNUVVJFIChtbSkgMjBrbSBANDVOCiAgICAgICAgdmFyIHN1c21QWSA9IHNtYXAuc2VsZWN0KCdzdXNtJykKICAgICAgICAgIC5maWx0ZXJEYXRlKHN0YXJ0RGF0ZSwgZW5kRGF0ZSkKICAgICAgICAgIC5maWx0ZXJCb3VuZHMobWFza19nZW9tZXRyeSkKICAgICAgICAgIC5tYXAoZnVuY3Rpb24oaW1hZ2Upe3JldHVybiBpbWFnZS5jbGlwKG1hc2tfZ2VvbWV0cnkpfSkgOwogICAgICAgIHZhciBzdXNtUFkgPSBzdXNtUFkucmVkdWNlKGVlLlJlZHVjZXIubWVkaWFuKCkpOwogICAgICAgIC8vIGV4cG9ydCB0byBnb29nbGUgZHJpdmUKICAgICAgICBFeHBvcnQuaW1hZ2UudG9Ecml2ZSh7CiAgICAgICAgICBpbWFnZTogc3NtUFksCiAgICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ19zc21fc21hcF8yMGttJyAgKyAnXycgKyB5ZWFyLAogICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgc2NhbGU6IDEwLAogICAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgIH0pOwogICAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICAgIGltYWdlOiBzdXNtUFksCiAgICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ19zdXNtX3NtYXBfMjBrbScgICsgJ18nICsgeWVhciwKICAgICAgICAgIGZvbGRlcjonR0VFX1N1cmZhY2VzJywKICAgICAgICAgIHNjYWxlOiAxMCwKICAgICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgICByZWdpb246IG1hc2tfZ2VvbWV0cnkKICAgICAgICB9KTsKICAgICAgfSAvLyBFTkQgSUYgWUVBUiA+PSAyMDE2CiAgICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICB9IC8vIEVORCBQWSBTTUFQCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLyBORFZJIAogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICBpZihuZHZpQ1k9PTEpewogICAgICB2YXIgeWVhciA9IENZOyAKICAgICAgdmFyIHN0YXJ0ID0gZWUuRGF0ZSh5ZWFyKyctMDEtMDEnKTsKICAgICAgdmFyIGVuZCA9IGVlLkRhdGUoeWVhcisnLTAzLTMwJyk7IC8vCiAgICAgIC8vIGJhc2VkIG9uIHllYXIgZGVjaWRlIHdoYXQgZGF0YSBzb3VyY2UgdG8gdXNlCiAgICAgIGlmKENZID49IDIwMTYpewogICAgICAgIC8vIGNhbGN1bGF0ZXMgbmR2aSBAIDEwbSByZXNvbHV0aW9uIGZyb20gU2VudGluZWwtMiAKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICAvLyBTZW50aW5lbCAyICgxMCBtKQogICAgICAgIC8vQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQAogICAgICAgIC8vIHMyX2ZpbHRlcjogZmlsdGVycyBhbGwgYXZhaWwgc2VudGluZWwgMiAoczIpIGltYWdlczogbGltaXQgc3BhdGlhbCBleHRlbnQgCiAgICAgICAgLy8gdG8gdGhlIGJvdW5kYXJ5IGFuZCBmaWx0ZXIgZGF0ZSByYW5nZSBieSBzdGFydCBhbmQgZW5kIHZhcnMgZGVmaW5lZCBhYm92ZQogICAgICAgIHZhciBzMnRvYV9maWx0ZXJDWSA9IHMydG9hCiAgICAgICAgICAuZmlsdGVyQm91bmRzKGZhcm1fbmFtZSkKICAgICAgICAgIC5maWx0ZXJEYXRlKHN0YXJ0LCBlbmQpCiAgICAgICAgICAvLyBQcmUtZmlsdGVyIHRvIGdldCBsZXNzIGNsb3VkeSBncmFudWxlcy4KICAgICAgICAgIC5maWx0ZXIoZWUuRmlsdGVyLmx0KCdDTE9VRFlfUElYRUxfUEVSQ0VOVEFHRScsIDIwKSkKICAgICAgICAgIC5tYXAobWFza1MyY2xvdWRzKTsKICAgICAgICAvLyBjb21wdXRlIG5kdmkgdXNpbmcgcmVkIGJhbmQgNCBhbmQgTklSIGJhbmQgOGE7IGNhbGN1bGF0ZWQgYXMKICAgICAgICAvLyA6IChiOC1iNCkvKGI4K2I0KQogICAgICAgIHZhciBuZHZpVE9BQ1kgPSBzMnRvYV9maWx0ZXJDWS5tYXAoZnVuY3Rpb24oaW1nKXsKICAgICAgICAgIHZhciByZWQgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCNCcpKTsKICAgICAgICAgIHZhciBuaXIgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCOCcpKTsKICAgICAgICAgIHJldHVybiAobmlyLnN1YnRyYWN0KHJlZCkpLmRpdmlkZShuaXIuYWRkKHJlZCkpLnJlbmFtZSgnbmR2aScpOwogICAgICAgIH0pOwogICAgICAgIC8vIE1ha2UgYSAiZ3JlZW5lc3QiIHBpeGVsIGNvbXBvc2l0ZS4KICAgICAgICB2YXIgbmR2aV85NVRPQUNZID0gbmR2aVRPQUNZLnF1YWxpdHlNb3NhaWMoJ25kdmknKTsKICAgICAgICAvLyBjbGlwIGltYWdlcwogICAgICAgIHZhciBtYXNrID0gZWUuRmVhdHVyZUNvbGxlY3Rpb24oZmFybV9uYW1lKTsKICAgICAgICB2YXIgbmR2aV85NV9jbGlwVE9BQ1kgPSBuZHZpXzk1VE9BQ1kuY2xpcChtYXNrKTsKICAgICAgICB2YXIgbWFza19nZW9tZXRyeSA9IG1hc2suZ2VvbWV0cnkoKS5ib3VuZHMoKTsKICAgICAgICAvLyBleHBvcnQgdG8gZ29vZ2xlIGRyaXZlCiAgICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgICAgaW1hZ2U6IG5kdmlfOTVfY2xpcFRPQUNZLAogICAgICAgICAgZGVzY3JpcHRpb246IGN1cnJlbnRfZmFybSArICdfbmR2aV9TMl8xMG0nICArICdfJyArIHllYXIgKyAnX21hcicsCiAgICAgICAgICBmb2xkZXI6J0dFRV9TdXJmYWNlcycsCiAgICAgICAgICBzY2FsZTogMTAsCiAgICAgICAgICBjcnM6ICdFUFNHOjQzMjYnLAogICAgICAgICAgcmVnaW9uOiBtYXNrX2dlb21ldHJ5CiAgICAgICAgfSk7CiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgLy8gTGFuZHNhdCA4ICgxMCBtKQogICAgICAgIC8vQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQAogICAgICAgICAgdmFyIEw4U1JDWV9maWx0ZXIgPSBMOHNyCiAgICAgICAgICAgIC5maWx0ZXJCb3VuZHMoZmFybV9uYW1lKQogICAgICAgICAgICAuZmlsdGVyRGF0ZShzdGFydCwgZW5kKQogICAgICAgICAgICAubWFwKG1hc2tMOHNyKTsKICAgICAgICAgIHZhciBuZHZpU1JDWUw4ID0gTDhTUkNZX2ZpbHRlci5tYXAoZnVuY3Rpb24oaW1nKXsKICAgICAgICAgICAgdmFyIHJlZCA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I0JykpOwogICAgICAgICAgICB2YXIgbmlyID0gZWUuSW1hZ2UoaW1nLnNlbGVjdCgnQjUnKSk7CiAgICAgICAgICAgIHJldHVybiAobmlyLnN1YnRyYWN0KHJlZCkpLmRpdmlkZShuaXIuYWRkKHJlZCkpLnJlbmFtZSgnbmR2aScpOwogICAgICAgICAgfSk7CiAgICAgICAgICAvLyBNYWtlIGEgImdyZWVuZXN0IiBwaXhlbCBjb21wb3NpdGUuCiAgICAgICAgICB2YXIgbmR2aV85NVNSQ1lMOCA9IG5kdmlTUkNZTDgucXVhbGl0eU1vc2FpYygnbmR2aScpOwogICAgICAgICAgLy8gY2xpcCBpbWFnZXMKICAgICAgICAgIHZhciBtYXNrID0gZWUuRmVhdHVyZUNvbGxlY3Rpb24oZmFybV9uYW1lKTsKICAgICAgICAgIHZhciBuZHZpXzk1X2NsaXBTUkNZTDggPSBuZHZpXzk1U1JDWUw4LmNsaXAobWFzayk7CiAgICAgICAgICB2YXIgbWFza19nZW9tZXRyeSA9IG1hc2suZ2VvbWV0cnkoKS5ib3VuZHMoKTsKICAgICAgICAgIC8vIGV4cG9ydCB0byBnb29nbGUgZHJpdmUKICAgICAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICAgICAgaW1hZ2U6IG5kdmlfOTVfY2xpcFNSQ1lMOCwKICAgICAgICAgICAgZGVzY3JpcHRpb246IGN1cnJlbnRfZmFybSArICdfbmR2aV9MOF8zMG0nICArICdfJyArIHllYXIgKyAnX21hcicsCiAgICAgICAgICAgIGZvbGRlcjonR0VFX1N1cmZhY2VzJywKICAgICAgICAgICAgc2NhbGU6IDMwLAogICAgICAgICAgICBjcnM6ICdFUFNHOjQzMjYnLAogICAgICAgICAgICByZWdpb246IG1hc2tfZ2VvbWV0cnkKICAgICAgICAgIH0pOwogICAgICB9ZWxzZXsgLy8gRU5EIElGIENZID49IDIwMTYKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICAvLyBMQU5EU0FUIDUgKDE5OTlweSB0byAyMDEyY3kpCiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgaWYoQ1kgPD0gMjAxMil7IAogICAgICAgICAgdmFyIEw1U1JDWV9maWx0ZXIgPSBMNXNyCiAgICAgICAgICAgIC5maWx0ZXJCb3VuZHMoZmFybV9uYW1lKQogICAgICAgICAgICAuZmlsdGVyRGF0ZShzdGFydCwgZW5kKQogICAgICAgICAgICAubWFwKGNsb3VkTWFza0w0NTcpOwogICAgICAgICAgdmFyIG5kdmlTUkNZTDUgPSBMNVNSQ1lfZmlsdGVyLm1hcChmdW5jdGlvbihpbWcpewogICAgICAgICAgICB2YXIgcmVkID0gZWUuSW1hZ2UoaW1nLnNlbGVjdCgnQjMnKSk7CiAgICAgICAgICAgIHZhciBuaXIgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCNCcpKTsKICAgICAgICAgICAgcmV0dXJuIChuaXIuc3VidHJhY3QocmVkKSkuZGl2aWRlKG5pci5hZGQocmVkKSkucmVuYW1lKCduZHZpJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIE1ha2UgYSAiZ3JlZW5lc3QiIHBpeGVsIGNvbXBvc2l0ZS4KICAgICAgICAgIHZhciBuZHZpXzk1U1JDWUw1ID0gbmR2aVNSQ1lMNS5xdWFsaXR5TW9zYWljKCduZHZpJyk7CiAgICAgICAgICAvLyBjbGlwIGltYWdlcwogICAgICAgICAgdmFyIG1hc2sgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbihmYXJtX25hbWUpOwogICAgICAgICAgdmFyIG5kdmlfOTVfY2xpcFNSQ1lMNSA9IG5kdmlfOTVTUkNZTDUuY2xpcChtYXNrKTsKICAgICAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICAgICAgLy8gZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgICAgICBpbWFnZTogbmR2aV85NV9jbGlwU1JDWUw1LAogICAgICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ19uZHZpX0w1XzMwbScgICsgJ18nICsgeWVhciArICdfbWFyJywKICAgICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgICBzY2FsZTogMzAsCiAgICAgICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgICAgfSk7CiAgICAgICAgfSAvLyBFTkQgTDUgSUYgQ1kgPD0yMDEyCiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgLy8gTEFORFNBVCA3ICgyMDEycHkgJiAyMDEzY3kpCiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgaWYoQ1kgPT0gMjAxMyl7IAogICAgICAgICAgdmFyIEw3U1JDWV9maWx0ZXIgPSBMN3NyCiAgICAgICAgICAgIC5maWx0ZXJCb3VuZHMoZmFybV9uYW1lKQogICAgICAgICAgICAuZmlsdGVyRGF0ZShzdGFydCwgZW5kKQogICAgICAgICAgICAubWFwKGNsb3VkTWFza0w0NTcpOwogICAgICAgICAgdmFyIG5kdmlTUkNZTDcgPSBMN1NSQ1lfZmlsdGVyLm1hcChmdW5jdGlvbihpbWcpewogICAgICAgICAgICB2YXIgcmVkID0gZWUuSW1hZ2UoaW1nLnNlbGVjdCgnQjMnKSk7CiAgICAgICAgICAgIHZhciBuaXIgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCNCcpKTsKICAgICAgICAgICAgcmV0dXJuIChuaXIuc3VidHJhY3QocmVkKSkuZGl2aWRlKG5pci5hZGQocmVkKSkucmVuYW1lKCduZHZpJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIE1ha2UgYSAiZ3JlZW5lc3QiIHBpeGVsIGNvbXBvc2l0ZS4KICAgICAgICAgIHZhciBuZHZpXzk1U1JDWUw3ID0gbmR2aVNSQ1lMNy5xdWFsaXR5TW9zYWljKCduZHZpJyk7CiAgICAgICAgICAvLyBjbGlwIGltYWdlcwogICAgICAgICAgdmFyIG1hc2sgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbihmYXJtX25hbWUpOwogICAgICAgICAgdmFyIG5kdmlfOTVfY2xpcFNSQ1lMNyA9IG5kdmlfOTVTUkNZTDcuY2xpcChtYXNrKTsKICAgICAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICAgICAgLy8gZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgICAgICBpbWFnZTogbmR2aV85NV9jbGlwU1JDWUw3LAogICAgICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ19uZHZpX0w3XzMwbScgICsgJ18nICsgeWVhciArICdfbWFyJywKICAgICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgICBzY2FsZTogMzAsCiAgICAgICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgICAgfSk7CiAgICAgICAgfSAvLyBFTkQgTDcgSUYgQ1kgPT0gMjAxMwogICAgICAgIC8vQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQAogICAgICAgIC8vIExBTkRTQVQgOCAoMjAxM3B5IChhcHJpbCAtIGRlYykgdG8gMjAxOGN5IG9yIDIwMTZweSkKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICBpZihDWSA+PSAyMDE0KXsgCiAgICAgICAgICB2YXIgTDhTUkNZX2ZpbHRlciA9IEw4c3IKICAgICAgICAgICAgLmZpbHRlckJvdW5kcyhmYXJtX25hbWUpCiAgICAgICAgICAgIC5maWx0ZXJEYXRlKHN0YXJ0LCBlbmQpCiAgICAgICAgICAgIC5tYXAobWFza0w4c3IpOwogICAgICAgICAgdmFyIG5kdmlTUkNZTDggPSBMOFNSQ1lfZmlsdGVyLm1hcChmdW5jdGlvbihpbWcpewogICAgICAgICAgICB2YXIgcmVkID0gZWUuSW1hZ2UoaW1nLnNlbGVjdCgnQjQnKSk7CiAgICAgICAgICAgIHZhciBuaXIgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCNScpKTsKICAgICAgICAgICAgcmV0dXJuIChuaXIuc3VidHJhY3QocmVkKSkuZGl2aWRlKG5pci5hZGQocmVkKSkucmVuYW1lKCduZHZpJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIE1ha2UgYSAiZ3JlZW5lc3QiIHBpeGVsIGNvbXBvc2l0ZS4KICAgICAgICAgIHZhciBuZHZpXzk1U1JDWUw4ID0gbmR2aVNSQ1lMOC5xdWFsaXR5TW9zYWljKCduZHZpJyk7CiAgICAgICAgICAvLyBjbGlwIGltYWdlcwogICAgICAgICAgdmFyIG1hc2sgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbihmYXJtX25hbWUpOwogICAgICAgICAgdmFyIG5kdmlfOTVfY2xpcFNSQ1lMOCA9IG5kdmlfOTVTUkNZTDguY2xpcChtYXNrKTsKICAgICAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICAgICAgLy8gZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgICAgICBpbWFnZTogbmR2aV85NV9jbGlwU1JDWUw4LAogICAgICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ19uZHZpX0w4XzMwbScgICsgJ18nICsgeWVhciArICdfbWFyJywKICAgICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgICBzY2FsZTogMzAsCiAgICAgICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgICAgfSk7CiAgICAgICAgfSAvLyBFTkQgTDggSUYgQ1kgPj0gMjAxNCBBTkQgIENZIDw9IDIwMTcKICAgICAgfSAvLyBFTkQgSUYgTk9UID49IDIwMTggUzIKICAgIH0gLy8gZW5kIGlmIGN1cnJlbnQgeWVhciBuZHZpCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlvdXMgeWVhciAoZnVsbCB5ZWFyKQogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGlmKG5kdmlQWT09MSl7CiAgICAgIHZhciB5ZWFyID0gUFk7IC8vICAKICAgICAgdmFyIHN0YXJ0ID0gZWUuRGF0ZSh5ZWFyKyctMDEtMDEnKTsKICAgICAgdmFyIGVuZCA9IGVlLkRhdGUoeWVhcisnLTEyLTMxJyk7IC8vCiAgICAgIGlmKFBZID49IDIwMTYpewogICAgICAgIC8vIGNhbGN1bGF0ZXMgbmR2aSBAIDEwbSByZXNvbHV0aW9uIGZyb20gU2VudGluZWwtMiAKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICAvLyBTZW50aW5lbCAyICgxMG0pCiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgLy8gczJfZmlsdGVyOiBmaWx0ZXJzIGFsbCBhdmFpbCBzZW50aW5lbCAyIChzMikgaW1hZ2VzOiBsaW1pdCBzcGF0aWFsIGV4dGVudCAKICAgICAgICAvLyB0byB0aGUgYm91bmRhcnkgYW5kIGZpbHRlciBkYXRlIHJhbmdlIGJ5IHN0YXJ0IGFuZCBlbmQgdmFycyBkZWZpbmVkIGFib3ZlCiAgICAgICAgdmFyIHMydG9hX2ZpbHRlclBZID0gczJ0b2EKICAgICAgICAgIC5maWx0ZXJCb3VuZHMoZmFybV9uYW1lKQogICAgICAgICAgLmZpbHRlckRhdGUoc3RhcnQsIGVuZCkKICAgICAgICAgIC8vIFByZS1maWx0ZXIgdG8gZ2V0IGxlc3MgY2xvdWR5IGdyYW51bGVzLgogICAgICAgICAgLmZpbHRlcihlZS5GaWx0ZXIubHQoJ0NMT1VEWV9QSVhFTF9QRVJDRU5UQUdFJywgMjApKQogICAgICAgICAgLm1hcChtYXNrUzJjbG91ZHMpOwogICAgICAgIC8vIGNvbXB1dGUgbmR2aSB1c2luZyByZWQgYmFuZCA0IGFuZCBOSVIgYmFuZCA4YTsgY2FsY3VsYXRlZCBhcwogICAgICAgIC8vIDogKGI4LWI0KS8oYjgrYjQpCiAgICAgICAgdmFyIG5kdmlUT0FQWSA9IHMydG9hX2ZpbHRlclBZLm1hcChmdW5jdGlvbihpbWcpewogICAgICAgICAgdmFyIHJlZCA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I0JykpOwogICAgICAgICAgdmFyIG5pciA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I4JykpOwogICAgICAgICAgcmV0dXJuIChuaXIuc3VidHJhY3QocmVkKSkuZGl2aWRlKG5pci5hZGQocmVkKSkucmVuYW1lKCduZHZpJyk7CiAgICAgICAgfSk7CiAgICAgICAgLy8gTWFrZSBhICJncmVlbmVzdCIgcGl4ZWwgY29tcG9zaXRlLgogICAgICAgIHZhciBuZHZpXzk1VE9BUFkgPSBuZHZpVE9BUFkucXVhbGl0eU1vc2FpYygnbmR2aScpOwogICAgICAgIC8vIGNsaXAgaW1hZ2VzCiAgICAgICAgdmFyIG1hc2sgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbihmYXJtX25hbWUpOwogICAgICAgIHZhciBuZHZpXzk1X2NsaXBUT0FQWSA9IG5kdmlfOTVUT0FQWS5jbGlwKG1hc2spOwogICAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICAgIC8vZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICAgIGltYWdlOiBuZHZpXzk1X2NsaXBUT0FQWSwKICAgICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnX25kdmlfUzJfMTBtJyAgKyAnXycgKyB5ZWFyLAogICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgc2NhbGU6IDEwLAogICAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgIH0pOwogICAgICAgIC8vQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQAogICAgICAgIC8vIExhbmRzYXQgOCAoMzBtKQogICAgICAgIC8vQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQAogICAgICAgIHZhciBMOFNSUFlfZmlsdGVyID0gTDhzcgogICAgICAgICAgLmZpbHRlckJvdW5kcyhmYXJtX25hbWUpCiAgICAgICAgICAuZmlsdGVyRGF0ZShzdGFydCwgZW5kKQogICAgICAgICAgLm1hcChtYXNrTDhzcik7CiAgICAgICAgdmFyIG5kdmlTUlBZZmlsdGVyTDggPSBMOFNSUFlfZmlsdGVyLm1hcChmdW5jdGlvbihpbWcpewogICAgICAgICAgdmFyIHJlZCA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I0JykpOwogICAgICAgICAgdmFyIG5pciA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I1JykpOwogICAgICAgICAgcmV0dXJuIChuaXIuc3VidHJhY3QocmVkKSkuZGl2aWRlKG5pci5hZGQocmVkKSkucmVuYW1lKCduZHZpJyk7CiAgICAgICAgfSk7CiAgICAgICAgLy8gTWFrZSBhICJncmVlbmVzdCIgcGl4ZWwgY29tcG9zaXRlLgogICAgICAgIHZhciBuZHZpXzk1U1JQWWZpbHRlckw4ID0gbmR2aVNSUFlmaWx0ZXJMOC5xdWFsaXR5TW9zYWljKCduZHZpJyk7CiAgICAgICAgLy8gY2xpcCBpbWFnZXMKICAgICAgICB2YXIgbWFzayA9IGVlLkZlYXR1cmVDb2xsZWN0aW9uKGZhcm1fbmFtZSk7CiAgICAgICAgdmFyIG5kdmlfOTVfY2xpcFNSUFlmaWx0ZXJMOCA9IG5kdmlfOTVTUlBZZmlsdGVyTDguY2xpcChtYXNrKTsKICAgICAgICB2YXIgbWFza19nZW9tZXRyeSA9IG1hc2suZ2VvbWV0cnkoKS5ib3VuZHMoKTsKICAgICAgICAvLyBleHBvcnQgdG8gZ29vZ2xlIGRyaXZlCiAgICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgICAgaW1hZ2U6IG5kdmlfOTVfY2xpcFNSUFlmaWx0ZXJMOCwKICAgICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnX25kdmlfTDhfMzBtJyAgKyAnXycgKyB5ZWFyLAogICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgc2NhbGU6IDMwLAogICAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgIH0pOwogICAgICB9ZWxzZXsgLy8gRU5EIFMyIFBZID49IDIwMTYKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICAvLyBMQU5EU0FUIDUgKDE5OTlweSAmIDIwMTJjeSkKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICBpZihQWSA8PSAyMDExKXsgCiAgICAgICAgICB2YXIgTDVTUlBZX2ZpbHRlciA9IEw1c3IKICAgICAgICAgICAgLmZpbHRlckJvdW5kcyhmYXJtX25hbWUpCiAgICAgICAgICAgIC5maWx0ZXJEYXRlKHN0YXJ0LCBlbmQpCiAgICAgICAgICAgIC5tYXAoY2xvdWRNYXNrTDQ1Nyk7CiAgICAgICAgICB2YXIgbmR2aVNSUFlmaWx0ZXJMNSA9IEw1U1JQWV9maWx0ZXIubWFwKGZ1bmN0aW9uKGltZyl7CiAgICAgICAgICAgIHZhciByZWQgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCMycpKTsKICAgICAgICAgICAgdmFyIG5pciA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I0JykpOwogICAgICAgICAgICByZXR1cm4gKG5pci5zdWJ0cmFjdChyZWQpKS5kaXZpZGUobmlyLmFkZChyZWQpKS5yZW5hbWUoJ25kdmknKTsKICAgICAgICAgIH0pOwogICAgICAgICAgLy8gTWFrZSBhICJncmVlbmVzdCIgcGl4ZWwgY29tcG9zaXRlLgogICAgICAgICAgdmFyIG5kdmlfOTVTUlBZZmlsdGVyTDUgPSBuZHZpU1JQWWZpbHRlckw1LnF1YWxpdHlNb3NhaWMoJ25kdmknKTsKICAgICAgICAgIC8vIGNsaXAgaW1hZ2VzCiAgICAgICAgICB2YXIgbWFzayA9IGVlLkZlYXR1cmVDb2xsZWN0aW9uKGZhcm1fbmFtZSk7CiAgICAgICAgICB2YXIgbmR2aV85NV9jbGlwU1JQWWZpbHRlckw1ID0gbmR2aV85NVNSUFlmaWx0ZXJMNS5jbGlwKG1hc2spOwogICAgICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgICAgICAvLyBleHBvcnQgdG8gZ29vZ2xlIGRyaXZlCiAgICAgICAgICBFeHBvcnQuaW1hZ2UudG9Ecml2ZSh7CiAgICAgICAgICAgIGltYWdlOiBuZHZpXzk1X2NsaXBTUlBZZmlsdGVyTDUsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnX25kdmlfTDVfMzBtJyAgKyAnXycgKyB5ZWFyLAogICAgICAgICAgICBmb2xkZXI6J0dFRV9TdXJmYWNlcycsCiAgICAgICAgICAgIHNjYWxlOiAzMCwKICAgICAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICAgICAgcmVnaW9uOiBtYXNrX2dlb21ldHJ5CiAgICAgICAgICB9KTsKICAgICAgICB9IC8vIEVORCBMNSBGT1IgMTk5OSB0byAyMDExIFBZCiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgLy8gTEFORFNBVCA3ICgyMDEycHkgJiAyMDEzY3kpCiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgaWYoUFkgPT0gMjAxMil7IAogICAgICAgICAgdmFyIEw3U1JQWV9maWx0ZXIgPSBMN3NyCiAgICAgICAgICAgIC5maWx0ZXJCb3VuZHMoZmFybV9uYW1lKQogICAgICAgICAgICAuZmlsdGVyRGF0ZShzdGFydCwgZW5kKQogICAgICAgICAgICAubWFwKGNsb3VkTWFza0w0NTcpOwogICAgICAgICAgdmFyIG5kdmlTUlBZZmlsdGVyTDcgPSBMN1NSUFlfZmlsdGVyLm1hcChmdW5jdGlvbihpbWcpewogICAgICAgICAgICB2YXIgcmVkID0gZWUuSW1hZ2UoaW1nLnNlbGVjdCgnQjMnKSk7CiAgICAgICAgICAgIHZhciBuaXIgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCNCcpKTsKICAgICAgICAgICAgcmV0dXJuIChuaXIuc3VidHJhY3QocmVkKSkuZGl2aWRlKG5pci5hZGQocmVkKSkucmVuYW1lKCduZHZpJyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIC8vIE1ha2UgYSAiZ3JlZW5lc3QiIHBpeGVsIGNvbXBvc2l0ZS4KICAgICAgICAgIHZhciBuZHZpXzk1U1JQWWZpbHRlckw3ID0gbmR2aVNSUFlmaWx0ZXJMNy5xdWFsaXR5TW9zYWljKCduZHZpJyk7CiAgICAgICAgICAvLyBjbGlwIGltYWdlcwogICAgICAgICAgdmFyIG1hc2sgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbihmYXJtX25hbWUpOwogICAgICAgICAgdmFyIG5kdmlfOTVfY2xpcFNSUFlmaWx0ZXJMNyA9IG5kdmlfOTVTUlBZZmlsdGVyTDcuY2xpcChtYXNrKTsKICAgICAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICAgICAgLy8gZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgICAgICBpbWFnZTogbmR2aV85NV9jbGlwU1JQWWZpbHRlckw3LAogICAgICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ19uZHZpX0w3XzMwbScgICsgJ18nICsgeWVhciwKICAgICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgICBzY2FsZTogMzAsCiAgICAgICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgICAgfSk7CiAgICAgICAgfSAvLyBFTkQgTDcgRk9SIDIwMTIgUFkKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICAvLyBMQU5EU0FUIDggKDIwMTNweSAoYXByaWwgLSBkZWMpIHRvIDIwMThjeSBvciAyMDE2cHkpCiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgaWYoUFkgPj0gMjAxMyl7IAogICAgICAgICAgaWYoUFk9PTIwMTMpewogICAgICAgICAgICAvL0NIQU5HRSBEQVRFUyBUTyBBUFJJTCBUTyBERUMKICAgICAgICAgICAgdmFyIHN0YXJ0MTMgPSBlZS5EYXRlKHllYXIrJy0wNC0wMScpOwogICAgICAgICAgICB2YXIgZW5kMTMgPSBlZS5EYXRlKHllYXIrJy0xMi0zMScpOyAvLwogICAgICAgICAgICB2YXIgTDhTUlBZX2ZpbHRlciA9IEw4c3IKICAgICAgICAgICAgICAuZmlsdGVyQm91bmRzKGZhcm1fbmFtZSkKICAgICAgICAgICAgICAuZmlsdGVyRGF0ZShzdGFydDEzLCBlbmQxMykKICAgICAgICAgICAgICAubWFwKG1hc2tMOHNyKTsKICAgICAgICAgICAgdmFyIG5kdmlTUlBZZmlsdGVyTDggPSBMOFNSUFlfZmlsdGVyLm1hcChmdW5jdGlvbihpbWcpewogICAgICAgICAgICAgIHZhciByZWQgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCNCcpKTsKICAgICAgICAgICAgICB2YXIgbmlyID0gZWUuSW1hZ2UoaW1nLnNlbGVjdCgnQjUnKSk7CiAgICAgICAgICAgICAgcmV0dXJuIChuaXIuc3VidHJhY3QocmVkKSkuZGl2aWRlKG5pci5hZGQocmVkKSkucmVuYW1lKCduZHZpJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAvLyBNYWtlIGEgImdyZWVuZXN0IiBwaXhlbCBjb21wb3NpdGUuCiAgICAgICAgICAgIHZhciBuZHZpXzk1U1JQWWZpbHRlckw4ID0gbmR2aVNSUFlmaWx0ZXJMOC5xdWFsaXR5TW9zYWljKCduZHZpJyk7CiAgICAgICAgICAgIC8vIGNsaXAgaW1hZ2VzCiAgICAgICAgICAgIHZhciBtYXNrID0gZWUuRmVhdHVyZUNvbGxlY3Rpb24oZmFybV9uYW1lKTsKICAgICAgICAgICAgdmFyIG5kdmlfOTVfY2xpcFNSUFlmaWx0ZXJMOCA9IG5kdmlfOTVTUlBZZmlsdGVyTDguY2xpcChtYXNrKTsKICAgICAgICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgICAgICAgIC8vIGV4cG9ydCB0byBnb29nbGUgZHJpdmUKICAgICAgICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgICAgICAgIGltYWdlOiBuZHZpXzk1X2NsaXBTUlBZZmlsdGVyTDgsCiAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGN1cnJlbnRfZmFybSArICdfbmR2aV9MOF8zMG0nICArICdfJyArIHllYXIsCiAgICAgICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgICAgIHNjYWxlOiAzMCwKICAgICAgICAgICAgICBjcnM6ICdFUFNHOjQzMjYnLAogICAgICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgICAgICB9KTsKICAgICAgICAgIH1lbHNleyAvLyBlbmQgaWYgUFkgPT0gMjAxMwogICAgICAgICAgICAvLyBVU0UgTk9STUFMIERBVEVTIChKQU4gVE8gREVDKQogICAgICAgICAgICB2YXIgTDhTUlBZX2ZpbHRlciA9IEw4c3IKICAgICAgICAgICAgICAuZmlsdGVyQm91bmRzKGZhcm1fbmFtZSkKICAgICAgICAgICAgICAuZmlsdGVyRGF0ZShzdGFydCwgZW5kKQogICAgICAgICAgICAgIC5tYXAobWFza0w4c3IpOwogICAgICAgICAgICB2YXIgbmR2aVNSUFlmaWx0ZXJMOCA9IEw4U1JQWV9maWx0ZXIubWFwKGZ1bmN0aW9uKGltZyl7CiAgICAgICAgICAgICAgdmFyIHJlZCA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I0JykpOwogICAgICAgICAgICAgIHZhciBuaXIgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCNScpKTsKICAgICAgICAgICAgICByZXR1cm4gKG5pci5zdWJ0cmFjdChyZWQpKS5kaXZpZGUobmlyLmFkZChyZWQpKS5yZW5hbWUoJ25kdmknKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIE1ha2UgYSAiZ3JlZW5lc3QiIHBpeGVsIGNvbXBvc2l0ZS4KICAgICAgICAgICAgdmFyIG5kdmlfOTVTUlBZZmlsdGVyTDggPSBuZHZpU1JQWWZpbHRlckw4LnF1YWxpdHlNb3NhaWMoJ25kdmknKTsKICAgICAgICAgICAgLy8gY2xpcCBpbWFnZXMKICAgICAgICAgICAgdmFyIG1hc2sgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbihmYXJtX25hbWUpOwogICAgICAgICAgICB2YXIgbmR2aV85NV9jbGlwU1JQWWZpbHRlckw4ID0gbmR2aV85NVNSUFlmaWx0ZXJMOC5jbGlwKG1hc2spOwogICAgICAgICAgICB2YXIgbWFza19nZW9tZXRyeSA9IG1hc2suZ2VvbWV0cnkoKS5ib3VuZHMoKTsKICAgICAgICAgICAgLy8gZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICAgICAgICBFeHBvcnQuaW1hZ2UudG9Ecml2ZSh7CiAgICAgICAgICAgICAgaW1hZ2U6IG5kdmlfOTVfY2xpcFNSUFlmaWx0ZXJMOCwKICAgICAgICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ19uZHZpX0w4XzMwbScgICsgJ18nICsgeWVhciwKICAgICAgICAgICAgICBmb2xkZXI6J0dFRV9TdXJmYWNlcycsCiAgICAgICAgICAgICAgc2NhbGU6IDMwLAogICAgICAgICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgICAgICAgcmVnaW9uOiBtYXNrX2dlb21ldHJ5CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSAvLyBlbmQgaWYgbm90IHB5ID09IDIwMTMgKGFwciB0byBkZWMgTDgpCiAgICAgICAgfSAvLyBFTkQgTDggRk9SIDIwMTMgdG8gMjAxNSBQWQogICAgICB9IC8vIEVORCBTMiBFTFNFIFBZID49IDIwMTYgCiAgICB9IC8vIEVORCBQWSBORFZJCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8KICAgIC8vIE5EUkUgCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGlmKG5kcmVDWT09MSl7CiAgICAgIHZhciB5ZWFyID0gQ1k7IAogICAgICB2YXIgc3RhcnQgPSBlZS5EYXRlKHllYXIrJy0wMS0wMScpOwogICAgICB2YXIgZW5kID0gZWUuRGF0ZSh5ZWFyKyctMDMtMzAnKTsgLy8KICAgICAgLy8gYmFzZWQgb24geWVhciBkZWNpZGUgd2hhdCBkYXRhIHNvdXJjZSB0byB1c2UKICAgICAgaWYoQ1kgPj0gMjAxNil7CiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgLy8gU2VudGluZWwgMiAoMTBtKQogICAgICAgIC8vQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQAogICAgICAgIC8vIGNhbGN1bGF0ZXMgbmRyZSBAIDEwbSByZXNvbHV0aW9uIGZyb20gU2VudGluZWwtMiAKICAgICAgICAvLyBzMl9maWx0ZXI6IGZpbHRlcnMgYWxsIGF2YWlsIHNlbnRpbmVsIDIgKHMyKSBpbWFnZXM6IGxpbWl0IHNwYXRpYWwgZXh0ZW50IAogICAgICAgIC8vIHRvIHRoZSBib3VuZGFyeSBhbmQgZmlsdGVyIGRhdGUgcmFuZ2UgYnkgc3RhcnQgYW5kIGVuZCB2YXJzIGRlZmluZWQgYWJvdmUKICAgICAgICB2YXIgczJ0b2FfZmlsdGVyQ1kgPSBzMnRvYQogICAgICAgICAgLmZpbHRlckJvdW5kcyhmYXJtX25hbWUpCiAgICAgICAgICAuZmlsdGVyRGF0ZShzdGFydCwgZW5kKQogICAgICAgICAgLy8gUHJlLWZpbHRlciB0byBnZXQgbGVzcyBjbG91ZHkgZ3JhbnVsZXMuCiAgICAgICAgICAuZmlsdGVyKGVlLkZpbHRlci5sdCgnQ0xPVURZX1BJWEVMX1BFUkNFTlRBR0UnLCAyMCkpCiAgICAgICAgICAubWFwKG1hc2tTMmNsb3Vkcyk7CiAgICAgICAgLy8gY29tcHV0ZSBuZHJlIHVzaW5nIHJlZCBlZGdlIGJhbmQgMSBhbmQgcmVkIGVkZ2UgYmFuZCAyOyBjYWxjdWxhdGVkIGFzCiAgICAgICAgLy8gOiAoYjYtYjUpLyhiNitiNSkKICAgICAgICB2YXIgbmRyZVRPQUNZID0gczJ0b2FfZmlsdGVyQ1kubWFwKGZ1bmN0aW9uKGltZyl7CiAgICAgICAgICB2YXIgcmUxID0gZWUuSW1hZ2UoaW1nLnNlbGVjdCgnQjUnKSk7CiAgICAgICAgICB2YXIgcmUyID0gZWUuSW1hZ2UoaW1nLnNlbGVjdCgnQjYnKSk7CiAgICAgICAgICByZXR1cm4gKHJlMS5zdWJ0cmFjdChyZTIpKS5kaXZpZGUocmUxLmFkZChyZTIpKS5yZW5hbWUoJ25kcmUnKTsKICAgICAgICB9KTsKICAgICAgICAvLyBNYWtlIGEgImdyZWVuZXN0IiBwaXhlbCBjb21wb3NpdGUuCiAgICAgICAgdmFyIG5kcmVfOTVUT0FDWSA9IG5kcmVUT0FDWS5xdWFsaXR5TW9zYWljKCduZHJlJyk7CiAgICAgICAgLy8gY2xpcCBpbWFnZXMKICAgICAgICB2YXIgbWFzayA9IGVlLkZlYXR1cmVDb2xsZWN0aW9uKGZhcm1fbmFtZSk7CiAgICAgICAgdmFyIG5kcmVfOTVfY2xpcFRPQUNZID0gbmRyZV85NVRPQUNZLmNsaXAobWFzayk7CiAgICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgICAgLy8gZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICAgIGltYWdlOiBuZHJlXzk1X2NsaXBUT0FDWSwKICAgICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnX25kcmVfUzJfMjBtJyAgKyAnXycgKyB5ZWFyICsgJ19tYXInLAogICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgc2NhbGU6IDIwLAogICAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgIH0pOwogICAgICB9IC8vIGVuZCBpZiB5ZWFyID49IDIwMTgKICAgIH0gLy8gZW5kIGlmIGN1cnJlbnQgeWVhciBuZHJlCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlvdXMgeWVhciAoZnVsbCB5ZWFyKQogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGlmKG5kcmVQWT09MSl7CiAgICAgIHZhciB5ZWFyID0gUFk7IC8vICAKICAgICAgdmFyIHN0YXJ0ID0gZWUuRGF0ZSh5ZWFyKyctMDEtMDEnKTsKICAgICAgdmFyIGVuZCA9IGVlLkRhdGUoeWVhcisnLTEyLTMxJyk7IC8vCiAgICAgIGlmKFBZID49IDIwMTYpewogICAgICAgIC8vQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQAogICAgICAgIC8vIFNlbnRpbmVsIDIgKDEwbSkKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICAvLyBjYWxjdWxhdGVzIG5kcmUgQCAxMG0gcmVzb2x1dGlvbiBmcm9tIFNlbnRpbmVsLTIgCiAgICAgICAgLy8gczJfZmlsdGVyOiBmaWx0ZXJzIGFsbCBhdmFpbCBzZW50aW5lbCAyIChzMikgaW1hZ2VzOiBsaW1pdCBzcGF0aWFsIGV4dGVudCAKICAgICAgICAvLyB0byB0aGUgYm91bmRhcnkgYW5kIGZpbHRlciBkYXRlIHJhbmdlIGJ5IHN0YXJ0IGFuZCBlbmQgdmFycyBkZWZpbmVkIGFib3ZlCiAgICAgICAgLy8vLy8gUFkgVE9BIFMyIHcvZmlsdGVyIC8vLy8vCiAgICAgICAgdmFyIHMydG9hX2ZpbHRlclBZID0gczJ0b2EKICAgICAgICAgIC5maWx0ZXJCb3VuZHMoZmFybV9uYW1lKQogICAgICAgICAgLmZpbHRlckRhdGUoc3RhcnQsIGVuZCkKICAgICAgICAgIC8vIFByZS1maWx0ZXIgdG8gZ2V0IGxlc3MgY2xvdWR5IGdyYW51bGVzLgogICAgICAgICAgLmZpbHRlcihlZS5GaWx0ZXIubHQoJ0NMT1VEWV9QSVhFTF9QRVJDRU5UQUdFJywgMjApKQogICAgICAgICAgLm1hcChtYXNrUzJjbG91ZHMpOwogICAgICAgIC8vIGNvbXB1dGUgbmRyZSB1c2luZyByZWQgYmFuZCA0IGFuZCBOSVIgYmFuZCA4YTsgY2FsY3VsYXRlZCBhcwogICAgICAgIC8vIDogKGI4LWI0KS8oYjgrYjQpCiAgICAgICAgdmFyIG5kcmVUT0FQWSA9IHMydG9hX2ZpbHRlclBZLm1hcChmdW5jdGlvbihpbWcpewogICAgICAgICAgdmFyIHJlMSA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I1JykpOwogICAgICAgICAgdmFyIHJlMiA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I2JykpOwogICAgICAgICAgcmV0dXJuIChyZTEuc3VidHJhY3QocmUyKSkuZGl2aWRlKHJlMS5hZGQocmUyKSkucmVuYW1lKCduZHJlJyk7CiAgICAgICAgfSk7CiAgICAgICAgLy8gTWFrZSBhICJncmVlbmVzdCIgcGl4ZWwgY29tcG9zaXRlLgogICAgICAgIHZhciBuZHJlXzk1VE9BUFkgPSBuZHJlVE9BUFkucXVhbGl0eU1vc2FpYygnbmRyZScpOwogICAgICAgIC8vIGNsaXAgaW1hZ2VzCiAgICAgICAgdmFyIG1hc2sgPSBlZS5GZWF0dXJlQ29sbGVjdGlvbihmYXJtX25hbWUpOwogICAgICAgIHZhciBuZHJlXzk1X2NsaXBUT0FQWSA9IG5kcmVfOTVUT0FQWS5jbGlwKG1hc2spOwogICAgICAgIHZhciBtYXNrX2dlb21ldHJ5ID0gbWFzay5nZW9tZXRyeSgpLmJvdW5kcygpOwogICAgICAgIC8vIGV4cG9ydCB0byBnb29nbGUgZHJpdmUKICAgICAgICBFeHBvcnQuaW1hZ2UudG9Ecml2ZSh7CiAgICAgICAgICBpbWFnZTogbmRyZV85NV9jbGlwVE9BUFksCiAgICAgICAgICBkZXNjcmlwdGlvbjogY3VycmVudF9mYXJtICsgJ19uZHJlX1MyXzIwbScgICsgJ18nICsgeWVhciwKICAgICAgICAgIGZvbGRlcjonR0VFX1N1cmZhY2VzJywKICAgICAgICAgIHNjYWxlOiAyMCwKICAgICAgICAgIGNyczogJ0VQU0c6NDMyNicsCiAgICAgICAgICByZWdpb246IG1hc2tfZ2VvbWV0cnkKICAgICAgICB9KTsKICAgICAgfSAvLyBlbmQgaWYgcHkgPj0gMjAxNgogICAgfSAvLyAhISEgRU5EIFBZIE5EUkUgISEhICAKICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLwogICAgLy8gQ0lSRSAKICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgaWYoY2xyZUNZPT0xKXsKICAgICAgdmFyIHllYXIgPSBDWTsgCiAgICAgIHZhciBzdGFydCA9IGVlLkRhdGUoeWVhcisnLTAxLTAxJyk7CiAgICAgIHZhciBlbmQgPSBlZS5EYXRlKHllYXIrJy0wMy0zMCcpOyAvLwogICAgICAvLyBiYXNlZCBvbiB5ZWFyIGRlY2lkZSB3aGF0IGRhdGEgc291cmNlIHRvIHVzZQogICAgICBpZihDWSA+PSAyMDE2KXsKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICAvLyBTZW50aW5lbCAyICgxMG0pCiAgICAgICAgLy9AQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBACiAgICAgICAgLy8gY2FsY3VsYXRlcyBjbHJlIEAgMTBtIHJlc29sdXRpb24gZnJvbSBTZW50aW5lbC0yIAogICAgICAgIC8vIHMyX2ZpbHRlcjogZmlsdGVycyBhbGwgYXZhaWwgc2VudGluZWwgMiAoczIpIGltYWdlczogbGltaXQgc3BhdGlhbCBleHRlbnQgCiAgICAgICAgLy8gdG8gdGhlIGJvdW5kYXJ5IGFuZCBmaWx0ZXIgZGF0ZSByYW5nZSBieSBzdGFydCBhbmQgZW5kIHZhcnMgZGVmaW5lZCBhYm92ZQogICAgICAgIHZhciBzMnRvYV9maWx0ZXJDWSA9IHMydG9hCiAgICAgICAgICAuZmlsdGVyQm91bmRzKGZhcm1fbmFtZSkKICAgICAgICAgIC5maWx0ZXJEYXRlKHN0YXJ0LCBlbmQpCiAgICAgICAgICAvLyBQcmUtZmlsdGVyIHRvIGdldCBsZXNzIGNsb3VkeSBncmFudWxlcy4KICAgICAgICAgIC5maWx0ZXIoZWUuRmlsdGVyLmx0KCdDTE9VRFlfUElYRUxfUEVSQ0VOVEFHRScsIDIwKSkKICAgICAgICAgIC5tYXAobWFza1MyY2xvdWRzKTsKICAgICAgICAvLyBjYWxjdWxhdGUgY2hsb3JvcGh5bGwgcmVkIGVkZ2UgaW5kZXggdXNpbmcgYmFuZHMgNyBhbmQgNTsgZm9ybXVsYSBmcm9tIAogICAgICAgIC8vIGNsZXZlcnMgYW5kIGdpdGxlc29uIDIwMTI6IChiNyAvIGI1KSAtIDEKICAgICAgICB2YXIgY2xyZVRPQUNZID0gczJ0b2FfZmlsdGVyQ1kubWFwKGZ1bmN0aW9uKGltZyl7CiAgICAgICAgICB2YXIgYjcgPSBlZS5JbWFnZShpbWcuc2VsZWN0KCdCNycpKTsKICAgICAgICAgIHZhciBiNSA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I1JykpOwogICAgICAgICAgcmV0dXJuIChiNy5kaXZpZGUoYjUpKS5zdWJ0cmFjdCgxKS5yZW5hbWUoJ2NscmUnKTsKICAgICAgICB9KTsKICAgICAgICAvLyBNYWtlIGEgImdyZWVuZXN0IiBwaXhlbCBjb21wb3NpdGUuCiAgICAgICAgdmFyIGNscmVfOTVUT0FDWSA9IGNscmVUT0FDWS5xdWFsaXR5TW9zYWljKCdjbHJlJyk7CiAgICAgICAgLy8gY2xpcCBpbWFnZXMKICAgICAgICB2YXIgbWFzayA9IGVlLkZlYXR1cmVDb2xsZWN0aW9uKGZhcm1fbmFtZSk7CiAgICAgICAgdmFyIGNscmVfOTVfY2xpcFRPQUNZID0gY2xyZV85NVRPQUNZLmNsaXAobWFzayk7CiAgICAgICAgdmFyIG1hc2tfZ2VvbWV0cnkgPSBtYXNrLmdlb21ldHJ5KCkuYm91bmRzKCk7CiAgICAgICAgLy8gZXhwb3J0IHRvIGdvb2dsZSBkcml2ZQogICAgICAgIEV4cG9ydC5pbWFnZS50b0RyaXZlKHsKICAgICAgICAgIGltYWdlOiBjbHJlXzk1X2NsaXBUT0FDWSwKICAgICAgICAgIGRlc2NyaXB0aW9uOiBjdXJyZW50X2Zhcm0gKyAnX2NscmVfUzJfMjBtJyAgKyAnXycgKyB5ZWFyICsgJ19tYXInLAogICAgICAgICAgZm9sZGVyOidHRUVfU3VyZmFjZXMnLAogICAgICAgICAgc2NhbGU6IDIwLAogICAgICAgICAgY3JzOiAnRVBTRzo0MzI2JywKICAgICAgICAgIHJlZ2lvbjogbWFza19nZW9tZXRyeQogICAgICAgIH0pOwogICAgICB9IC8vIGVuZCBpZiB5ZWFyID49IDIwMTYKICAgIH0gLy8gZW5kIGlmIGN1cnJlbnQgeWVhciBjbHJlCiAgICAvLy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQogICAgLy8gUHJldmlvdXMgeWVhciAoZnVsbCB5ZWFyKQogICAgLy8tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAgIGlmKGNscmVQWT09MSl7CiAgICAgIHZhciB5ZWFyID0gUFk7IC8vICAKICAgICAgdmFyIHN0YXJ0ID0gZWUuRGF0ZSh5ZWFyKyctMDEtMDEnKTsKICAgICAgdmFyIGVuZCA9IGVlLkRhdGUoeWVhcisnLTEyLTMxJyk7IC8vCiAgICAgIGlmKFBZID49IDIwMTYpewogICAgICAgIC8vQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQAogICAgICAgIC8vIFNlbnRpbmVsIDIgKDEwbSkKICAgICAgICAvL0BAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEAKICAgICAgICAvLyBjYWxjdWxhdGVzIGNscmUgQCAxMG0gcmVzb2x1dGlvbiBmcm9tIFNlbnRpbmVsLTIgCiAgICAgICAgLy8gczJfZmlsdGVyOiBmaWx0ZXJzIGFsbCBhdmFpbCBzZW50aW5lbCAyIChzMikgaW1hZ2VzOiBsaW1pdCBzcGF0aWFsIGV4dGVudCAKICAgICAgICAvLyB0byB0aGUgYm91bmRhcnkgYW5kIGZpbHRlciBkYXRlIHJhbmdlIGJ5IHN0YXJ0IGFuZCBlbmQgdmFycyBkZWZpbmVkIGFib3ZlCiAgICAgICAgdmFyIHMydG9hX2ZpbHRlclBZID0gczJ0b2EKICAgICAgICAgIC5maWx0ZXJCb3VuZHMoZmFybV9uYW1lKQogICAgICAgICAgLmZpbHRlckRhdGUoc3RhcnQsIGVuZCkKICAgICAgICAgIC8vIFByZS1maWx0ZXIgdG8gZ2V0IGxlc3MgY2xvdWR5IGdyYW51bGVzLgogICAgICAgICAgLmZpbHRlcihlZS5GaWx0ZXIubHQoJ0NMT1VEWV9QSVhFTF9QRVJDRU5UQUdFJywgMjApKQogICAgICAgICAgLm1hcChtYXNrUzJjbG91ZHMpOwogICAgICAgIC8vIGNhbGN1bGF0ZSBjaGxvcm9waHlsbCByZWQgZWRnZSBpbmRleCB1c2luZyBiYW5kcyA3IGFuZCA1OyBmb3JtdWxhIGZyb20gCiAgICAgICAgLy8gY2xldmVycyBhbmQgZ2l0bGVzb24gMjAxMjogKGI3IC8gYjUpIC0gMQogICAgICAgIHZhciBjbHJlVE9BUFkgPSBzMnRvYV9maWx0ZXJQWS5tYXAoZnVuY3Rpb24oaW1nKXsKICAgICAgICAgIHZhciBiNyA9IGVlLkltYWdlKGltZy5zZWxlY3QoJ0I3JykpOwogICAgICAgICAgdmFyIGI1ID0gZWUuSW1hZ2UoaW1nLnNlbGVjdCgnQjUnKSk7CiAgICAgICAgICByZXR1cm4gKGI3LmRpdmlkZShiNSkpLnN1YnRyYWN0KDEpLnJlbmFtZSgnY2xyZScpOwogICAgICAgIH0pOwogICAgICAgIC8vIE1ha2UgYSAiZ3JlZW5lc3QiIHBpeGVsIGNvbXBvc2l0ZS4KICAgICAgICB2YXIgY2xyZV85NVRPQVBZID0gY2xyZVRPQVBZLnF1YWxpdHlNb3NhaWMoJ2NscmUnKTsKICAgICAgICAvLyBjbGlwIGltYWdlcwogICAgICAgIHZhciBtYXNrID0gZWUuRmVhdHVyZUNvbGxlY3Rpb24oZmFybV9uYW1lKTsKICAgICAgICB2YXIgY2xyZV85NV9jbGlwVE9BUFkgPSBjbHJlXzk1VE9BUFkuY2xpcChtYXNrKTsKICAgICAgICB2YXIgbWFza19nZW9tZXRyeSA9IG1hc2suZ2VvbWV0cnkoKS5ib3VuZHMoKTsKICAgICAgICAvLyBleHBvcnQgdG8gZ29vZ2xlIGRyaXZlCiAgICAgICAgRXhwb3J0LmltYWdlLnRvRHJpdmUoewogICAgICAgICAgaW1hZ2U6IGNscmVfOTVfY2xpcFRPQVBZLAogICAgICAgICAgZGVzY3JpcHRpb246IGN1cnJlbnRfZmFybSArICdfY2xyZV9TMl8yMG0nICArICdfJyArIHllYXIsCiAgICAgICAgICBmb2xkZXI6J0dFRV9TdXJmYWNlcycsCiAgICAgICAgICBzY2FsZTogMjAsCiAgICAgICAgICBjcnM6ICdFUFNHOjQzMjYnLAogICAgICAgICAgcmVnaW9uOiBtYXNrX2dlb21ldHJ5CiAgICAgICAgfSk7CiAgICAgIH0gLy8gZW5kIGlmIHB5ID49IDIwMTYKICAgIH0gLy8gRU5EIFBZIENJUkUKICAgIC8vLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgICAKICAgIC8vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAgIC8vIEVORCBGQVJNUyBMT09QCiAgICAvLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqCiAgfQogIC8vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKICAvLyBFTkQgWUVBUlMgTE9PUAogIC8vKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioKfQoKCgoKCgoK" download="ofpe_gee_javascript.js">Download OFPE GEE Code</a>
<div class="figure">
<img src="run_gee/step_cre_1.png" alt="" />
<p class="caption">First few lines of the GEE OFPE code. This view is of TextEdit on a Mac.</p>
</div>
<p><strong>2.</strong> Browse to the <a href="https://code.earthengine.google.com/">Google Earth Engine Code Editor</a> and hit the red ‘NEW’ button in the left sided pane. Select and create any ‘Repository’ or ‘Folder’ objects, then create a new file. These can be named anything that you would like. You will need to make at least one repository.</p>
<div class="figure">
<img src="run_gee/step_cre_2.png" alt="" />
<p class="caption">Note that you will likely not have any repositories in the left side pane of the Google Earth Engine page. Follow the steps for any repositories or folders you desire before creating the file.</p>
</div>
<p><strong>3.</strong> Copy the text in the .txt file downloaded in Step 1 and paste it into the new file made in Step 3. You may need to browse to your new file. The open file name will appear at the top in the blue bar. DO NOT EDIT OR ADD ANY CODE YET. Wait until after following the end of this section. The next few steps refer to lines of code in the file downloaded in Step 1.</p>
<div class="figure">
<img src="run_gee/step_cre_3.png" alt="" />
<p class="caption">Paste the code from ‘ofpe_gee_javascript.txt’, downloaded in Step 1.</p>
</div>
<p><strong>4.</strong> First, for any assets you created in this <a href="gee_setup.html">tutorial</a>, enter all ‘farmer_farmername’ text strings in Line 88. Do not include the ’_bbox’ text here that I recommended adding in the tutorial.</p>
<p><img src="run_gee/step_cre_4.png" /></p>
<p><strong>5.</strong> Insert your Google Account Username in line 167. If you did not include ’_bbox’ at the end of your asset names, remove that from line 167. and make sure it matches your file structure.</p>
<p><img src="run_gee/step_cre_5.png" /></p>
<p><strong>6.</strong> Before moving onto the next section and before you make any edits that add lines to your file, note that the next section will demonstrate how to edit lines 67 - 82, 85, and 88. Remember these lines in case the line numbers do not match up when you edit your script later.</p>
<div class="figure">
<img src="run_gee/step_cre_6.png" alt="" />
<p class="caption">These lines are what we need to edit to change what data is downloaded. Lines 67 - 82 determine the parameters to download, 85 are the years to download data for, and line 88 is the farm boundaries to download data for.</p>
</div>
<p><strong>7.</strong> Assets need to be imported into the script before it will work. Copy and paste lines 13 to 22 and uncomment one of the sections. Hover your mouse over the uncommented code and select “Convert” in the pop-up window.</p>
<p><img src="run_gee/step_cre_7.png" /></p>
</div>
<div id="script-editingexecution" class="section level3">
<h3>Script Editing/Execution</h3>
<p>This section of the tutorial is for editing the OFPE script and executing it on an annual basis to collect relevant Google Earth Engine data. It can also be ran as often as required for any specified data.</p>
<p>The script downloaded and set up in the section above has a looped structure so that any combination of parameters, years, and farms can be ran at any time. However, note that any data downloaded always goes to the ‘GEE_Surfaces’ folder set up in your Google Drive in this <a href="gd_setup.html">tutorial</a>. Additionally, in the process detailed in these <a href="dat_import.html">diagrams</a>, the R script that imports data from Google Drive to the PostgreSQL database will always move all of the data in the Google Drive. So to avoid long processes, keep the Google Drive folder clean.</p>
<p><strong>1.</strong> Turn parameters on or off by changing their indicator to 1 or 0, respectively. In the image below only weather and vegetation data will be downloaded (precCY, precPY, gddCY, gddPY, ndviCY, ndviPY, ndreCY, ndrePY, clreCY, clrePY).</p>
<div class="figure">
<img src="run_gee/step_upd_1.png" alt="" />
<p class="caption">Note the changes in lines 67 - 82 from the default with ones indicating parameters that will be downloaded.</p>
</div>
<p><strong>2.</strong> Only include years that you would like to get data for. Data will only be downloaded if it is available for the year you select (i.e. Sentinel 2 data is not available prior to 2016). Remember that CY means that data for that year is gathered from 01-01 to 03-30. PY is the full year, 01-01 to 12-31 or 11-01 to 10-31 for precipitation (water year). So, for example, if you want to download precipitation data from the entirety of 2002, run precPY 2003. If you wanted NDVI data up to the decision point for 2005, run ndviCY 2005.</p>
<div class="figure">
<img src="run_gee/step_upd_1.png" alt="" />
<p class="caption">Note that the years selected here are all years between 2000 and 2020. Any subset or sequence of years can be selected, however if data from the datasets of the parameters you select are not available for those years, you will not get any data.</p>
</div>
<p><strong>3.</strong> Add or delete any Asset ID’s of farm bounding boxes to get data for. Only include the names of farms you want data for, just like for the years.</p>
<div class="figure">
<img src="run_gee/step_cre_4.png" alt="" />
<p class="caption">In the same line where you added the Asset ID’s in the creation tutorial, only keep the farms you want active by deleting or commenting out Asset ID’s.</p>
</div>
<p><strong>4.</strong> Now click ‘Run’. You will see the ‘Tasks’ tab appear orange if tasks are being initiated.</p>
<div class="figure">
<img src="run_gee/step_upd_4.png" alt="" />
<p class="caption">Note that some aspects of this image may be different. Blacked out sections are for MT OFPE farmer’s privacy.</p>
</div>
<p><strong>5.</strong> The initiated tasks need to be initialized. For each task, click the blue ‘RUN’ button. Then click ‘Run’ in the pop-up window. Repeat this process for every task you initialized.</p>
<p><img src="run_gee/step_upd_5a.png" /></p>
<div class="figure">
<img src="run_gee/step_upd_5b.png" alt="" />
<p class="caption">Note that some aspects of this image may be different. Blacked out sections are for MT OFPE farmer’s privacy.</p>
</div>
<p><strong>6.</strong> Now would be a good time to give you the link to <a href="https://github.com/kongdd">Dongdong Kong’s</a> <a href="https://github.com/kongdd/gee_monkey.git">gee_monkey</a> Google Earth Engine add-on that will make Step 5 not your worst nightmare. It’s a $10 well spent in my opinion…</p>
<p><img src="run_gee/step_upd_6.png" /></p>
<p>Now you’ve got data downloading from Google Earth Engine and is on it’s way to Google Drive. Again, see this <a href="dat_import.html">workflow</a> for the next steps of importing the Google Earth Engine data to the PostgreSQL database.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
